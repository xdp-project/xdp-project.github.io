<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Follow code and explain TC-qdisc offloading of TSN features</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/styles/bigblow/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="/styles/bigblow/css/bigblow.css"/>
<link rel="stylesheet" type="text/css" href="/styles/bigblow/css/hideshow.css"/>
<script type="text/javascript" src="/styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/bigblow.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="/styles/lib/js/jquery.stickytableheaders.min.js"></script>
</head>
<body>
<div id="content">
<h1 class="title">Follow code and explain TC-qdisc offloading of TSN features</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#Summary">Summary</a></li>
<li><a href="#Autogenerated-document-index">Autogenerated document index&#xa0;&#xa0;&#xa0;<span class="tag"><span class="toc">toc</span></span></a></li>
<li><a href="#Qdisc--ETF">Qdisc: ETF</a>
<ul>
<li><a href="#Drivers-supporting-HW-ETF">Drivers supporting HW-ETF</a></li>
</ul>
</li>
<li><a href="#Qdisc--taprio">Qdisc: taprio</a>
<ul>
<li><a href="#Drivers-supporting-HW-taprio">Drivers supporting HW-taprio</a></li>
</ul>
</li>
<li><a href="#Driver--igc">Driver: igc</a>
<ul>
<li><a href="#Setup-code--driver--igc-">Setup code (driver: igc)</a></li>
<li><a href="#TX-time-to-hardware--driver--igc-">TX time to hardware (driver: igc)</a></li>
</ul>
</li>
<li><a href="#Driver--igb">Driver: igb</a>
<ul>
<li><a href="#Setup-code--driver--igb-">Setup code (driver: igb)</a></li>
<li><a href="#TX-time-to-hardware--driver--igb-">TX time to hardware (driver: igb)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
Upstream kernel community choose to use the TC-qdisc system "offload" feature to
configure the NIC drivers TSN config. In this project we need to understand how
this works. As for XDP there is not such layer. Thus, either we have to design
our own config layer or collaborate with the existing TC layer.
</p>

<div id="outline-container-Summary" class="outline-2">
<h2 id="Summary"><a href="#Summary">Summary</a></h2>
<div class="outline-text-2" id="text-Summary">
<p>
Chip i225:
</p>
<ul class="org-ul">
<li>LaunchTime max 1 second into the future.</li>
<li>Descriptor: LaunchTime 30 bit (bits 61:32).</li>
<li>Transmit scheduler accuracy 6.4nsec (156.25 MHz clock).</li>
</ul>

<p>
Chip i210:
</p>
<ul class="org-ul">
<li>LaunchTime max 0.5 second into the future.</li>
<li>Descriptor: LaunchTime 25-bit (bits 56:32) with 32 nanosec granularity.</li>
<li>Limits: Only TX queue 0 and 1 supports LaunchTime.</li>
</ul>

<p>
Both drivers expect that upper Qdisc layer makes sure that launch timestamps are
bounded/sanitised to not exceed the bits available, and there by indirectly the
max time-horizon.
</p>

<p>
When exposing this to XDP and AF_XDP, we don't have this 'upper-layer'.
This is a design question how this is solved for XDP.
</p>
</div>
</div>

<div id="outline-container-Autogenerated-document-index" class="outline-2">
<h2 id="Autogenerated-document-index"><a href="#Autogenerated-document-index">Autogenerated document index&#xa0;&#xa0;&#xa0;<span class="tag"><span class="toc">toc</span></span></a></h2>
<div class="outline-text-2" id="text-Autogenerated-document-index">
<ul class="org-ul">
<li></li>
<li><ul class="org-ul">
<li></li>
</ul></li>
<li><ul class="org-ul">
<li></li>
</ul></li>
<li><ul class="org-ul">
<li></li>
<li></li>
</ul></li>
<li><ul class="org-ul">
<li></li>
<li></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-Qdisc--ETF" class="outline-2">
<h2 id="Qdisc--ETF"><a href="#Qdisc--ETF">Qdisc: ETF</a></h2>
<div class="outline-text-2" id="text-Qdisc--ETF">
<p>
ETF = Earliest TxTime First.
</p>

<p>
Use a rb-tree (data astructure) for storing and sorting packets based on the
transmission timestamp.
</p>

<p>
The desired transmission time comes from the SKB (<code>skb-&gt;tstamp</code>).
</p>

<p>
For offloading notice the two functions:
</p>
<ul class="org-ul">
<li>etf_disable_offload</li>
<li>etf_enable_offload</li>
</ul>

<p>
The both end-up calling the driver callback: <code>ndo_setup_tc()</code>
</p>
<div class="org-src-container">
<pre class="src src-C">err = ops-&gt;ndo_setup_tc(dev, TC_SETUP_QDISC_ETF, &amp;etf);
<span style="font-weight: bold;">if</span> (err &lt; 0)
      pr_warn(<span style="font-style: italic;">"Couldn't disable ETF offload for queue %d\n"</span>, etf.queue);
</pre>
</div>

<p>
The <code>etf</code> parameter have type  <code>struct tc_etf_qopt_offload</code>:
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">tc_etf_qopt_offload</span> {
       <span style="font-weight: bold; text-decoration: underline;">u8</span> <span style="font-weight: bold; font-style: italic;">enable</span>;
       <span style="font-weight: bold; text-decoration: underline;">s32</span> <span style="font-weight: bold; font-style: italic;">queue</span>;
};
</pre>
</div>

<p>
An important detail, that can be seen from this code, is that offloading happens
for a specific and single queue number.
</p>
</div>

<div id="outline-container-Drivers-supporting-HW-ETF" class="outline-3">
<h3 id="Drivers-supporting-HW-ETF"><a href="#Drivers-supporting-HW-ETF">Drivers supporting HW-ETF</a></h3>
<div class="outline-text-3" id="text-Drivers-supporting-HW-ETF">
<div class="org-src-container">
<pre class="src src-sh">$ gg TC_SETUP_QDISC_ETF drivers/
drivers/net/ethernet/freescale/enetc/enetc.c:   case TC_SETUP_QDISC_ETF:
drivers/net/ethernet/intel/igb/igb_main.c:      case TC_SETUP_QDISC_ETF:
drivers/net/ethernet/intel/igc/igc_main.c:      case TC_SETUP_QDISC_ETF:
drivers/net/ethernet/stmicro/stmmac/stmmac_main.c:      case TC_SETUP_QDISC_ETF:
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-Qdisc--taprio" class="outline-2">
<h2 id="Qdisc--taprio"><a href="#Qdisc--taprio">Qdisc: taprio</a></h2>
<div class="outline-text-2" id="text-Qdisc--taprio">
<p>
The TC 'taprio' qdisc is a "Time Aware Priority Scheduler".
Kernel code: <a href="https://elixir.bootlin.com/linux/v5.13-rc5/source/net/sched/sch_taprio.c">net/sched/sch_taprio.c</a>.
</p>

<p>
This qdisc is related to IEEE 802.1Qbv.
</p>
</div>

<div id="outline-container-Drivers-supporting-HW-taprio" class="outline-3">
<h3 id="Drivers-supporting-HW-taprio"><a href="#Drivers-supporting-HW-taprio">Drivers supporting HW-taprio</a></h3>
<div class="outline-text-3" id="text-Drivers-supporting-HW-taprio">
<div class="org-src-container">
<pre class="src src-sh">$ gg TC_SETUP_QDISC_TAPRIO drivers/
drivers/net/dsa/hirschmann/hellcreek.c: if (<span style="font-weight: bold;">type</span> != TC_SETUP_QDISC_TAPRIO)
drivers/net/dsa/ocelot/felix_vsc9959.c: case TC_SETUP_QDISC_TAPRIO:
drivers/net/dsa/sja1105/sja1105_main.c: case TC_SETUP_QDISC_TAPRIO:
drivers/net/ethernet/freescale/enetc/enetc.c:   case TC_SETUP_QDISC_TAPRIO:
drivers/net/ethernet/intel/igc/igc_main.c:      case TC_SETUP_QDISC_TAPRIO:
drivers/net/ethernet/stmicro/stmmac/stmmac_main.c:      case TC_SETUP_QDISC_TAPRIO:
drivers/net/ethernet/ti/am65-cpsw-qos.c:        case TC_SETUP_QDISC_TAPRIO:
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-Driver--igc" class="outline-2">
<h2 id="Driver--igc"><a href="#Driver--igc">Driver: igc</a></h2>
<div class="outline-text-2" id="text-Driver--igc">
</div>
<div id="outline-container-Setup-code--driver--igc-" class="outline-3">
<h3 id="Setup-code--driver--igc-"><a href="#Setup-code--driver--igc-">Setup code (driver: igc)</a></h3>
<div class="outline-text-3" id="text-Setup-code--driver--igc-">
<p>
The drivers <code>ndo_setup_tc()</code> callback tell us what offload <code>type</code> it supports.
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">igc_setup_tc</span>(<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">net_device</span> *<span style="font-weight: bold; font-style: italic;">dev</span>, <span style="font-weight: bold;">enum</span> <span style="font-weight: bold; text-decoration: underline;">tc_setup_type</span> <span style="font-weight: bold; font-style: italic;">type</span>,
                        <span style="font-weight: bold; text-decoration: underline;">void</span> *<span style="font-weight: bold; font-style: italic;">type_data</span>)
{
        <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_adapter</span> *<span style="font-weight: bold; font-style: italic;">adapter</span> = netdev_priv(dev);

        <span style="font-weight: bold;">switch</span> (type) {
        <span style="font-weight: bold;">case</span> TC_SETUP_QDISC_TAPRIO:
                <span style="font-weight: bold;">return</span> igc_tsn_enable_qbv_scheduling(adapter, type_data);

        <span style="font-weight: bold;">case</span> TC_SETUP_QDISC_ETF:
                <span style="font-weight: bold;">return</span> igc_tsn_enable_launchtime(adapter, type_data);

        <span style="font-weight: bold;">default</span>:
                <span style="font-weight: bold;">return</span> -EOPNOTSUPP;
        }
}
</pre>
</div>

<p>
Code to setup hardware for "LaunchTime":
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">igc_tsn_enable_launchtime</span>(<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_adapter</span> *<span style="font-weight: bold; font-style: italic;">adapter</span>,
                                     <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">tc_etf_qopt_offload</span> *<span style="font-weight: bold; font-style: italic;">qopt</span>)
{
        <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_hw</span> *<span style="font-weight: bold; font-style: italic;">hw</span> = &amp;adapter-&gt;hw;
        <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">err</span>;

        <span style="font-weight: bold;">if</span> (hw-&gt;mac.type != igc_i225)
                <span style="font-weight: bold;">return</span> -EOPNOTSUPP;

        err = igc_save_launchtime_params(adapter, qopt-&gt;queue, qopt-&gt;enable);
        <span style="font-weight: bold;">if</span> (err)
                <span style="font-weight: bold;">return</span> err;

        <span style="font-weight: bold;">return</span> igc_tsn_offload_apply(adapter);
}
</pre>
</div>

<p>
The specific <code>ring</code> queue enable 'ring-&gt;launchtime_enable', but there is also a
for-loop that for every TX ring resets members <code>start_time</code> and <code>end_time</code>, see:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">igc_save_launchtime_params</span>(<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_adapter</span> *<span style="font-weight: bold; font-style: italic;">adapter</span>, <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">queue</span>,
                                      <span style="font-weight: bold; text-decoration: underline;">bool</span> <span style="font-weight: bold; font-style: italic;">enable</span>)
{
        <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_ring</span> *<span style="font-weight: bold; font-style: italic;">ring</span>;
        <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">i</span>;

        <span style="font-weight: bold;">if</span> (queue &lt; 0 || queue &gt;= adapter-&gt;num_tx_queues)
                <span style="font-weight: bold;">return</span> -EINVAL;

        ring = adapter-&gt;tx_ring[queue];
        ring-&gt;launchtime_enable = enable;

        <span style="font-weight: bold;">if</span> (adapter-&gt;base_time)
                <span style="font-weight: bold;">return</span> 0;

        adapter-&gt;cycle_time = NSEC_PER_SEC;

        <span style="font-weight: bold;">for</span> (i = 0; i &lt; adapter-&gt;num_tx_queues; i++) {
                ring = adapter-&gt;tx_ring[i];
                ring-&gt;start_time = 0;
                ring-&gt;end_time = NSEC_PER_SEC;
        }

        <span style="font-weight: bold;">return</span> 0;
}

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">include/vdso/time64.h</span>
<span style="font-weight: bold;">#define</span> <span style="font-weight: bold; font-style: italic;">NSEC_PER_SEC</span>    1000000000L  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">10^9</span>
</pre>
</div>

<p>
The call <code>igc_tsn_offload_apply()</code> calls <a href="https://elixir.bootlin.com/linux/v5.12-rc8/source/drivers/net/ethernet/intel/igc/igc_tsn.c#L63">igc_tsn_enable_offload</a> that programs
the actual hardware registers.
</p>
</div>
</div>

<div id="outline-container-TX-time-to-hardware--driver--igc-" class="outline-3">
<h3 id="TX-time-to-hardware--driver--igc-"><a href="#TX-time-to-hardware--driver--igc-">TX time to hardware (driver: igc)</a></h3>
<div class="outline-text-3" id="text-TX-time-to-hardware--driver--igc-">
<p>
In function <a href="https://elixir.bootlin.com/linux/v5.12-rc8/source/drivers/net/ethernet/intel/igc/igc_main.c#L913">igc_tx_ctxtdesc</a> the the "launch_time" timestamp is transferred to
the hardware via the TX context descriptor (below <code>context_desc</code> type struct
igc_adv_tx_context_desc).
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">igc_tx_ctxtdesc</span>(<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_ring</span> *<span style="font-weight: bold; font-style: italic;">tx_ring</span>,
                            <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_tx_buffer</span> *<span style="font-weight: bold; font-style: italic;">first</span>,
                            <span style="font-weight: bold; text-decoration: underline;">u32</span> <span style="font-weight: bold; font-style: italic;">vlan_macip_lens</span>, <span style="font-weight: bold; text-decoration: underline;">u32</span> <span style="font-weight: bold; font-style: italic;">type_tucmd</span>,
                            <span style="font-weight: bold; text-decoration: underline;">u32</span> <span style="font-weight: bold; font-style: italic;">mss_l4len_idx</span>)
{
        <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_adv_tx_context_desc</span> *<span style="font-weight: bold; font-style: italic;">context_desc</span>;
        <span style="font-weight: bold; text-decoration: underline;">u16</span> <span style="font-weight: bold; font-style: italic;">i</span> = tx_ring-&gt;next_to_use;

        context_desc = IGC_TX_CTXTDESC(tx_ring, i);

        i++;
        tx_ring-&gt;next_to_use = (i &lt; tx_ring-&gt;count) ? i : 0;

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">set bits to identify this as an advanced context descriptor </span><span style="font-weight: bold; font-style: italic;">*/</span>
        type_tucmd |= IGC_TXD_CMD_DEXT | IGC_ADVTXD_DTYP_CTXT;

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">For i225, context index must be unique per ring. </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold;">if</span> (test_bit(IGC_RING_FLAG_TX_CTX_IDX, &amp;tx_ring-&gt;flags))
                mss_l4len_idx |= tx_ring-&gt;reg_idx &lt;&lt; 4;

        context_desc-&gt;vlan_macip_lens   = cpu_to_le32(vlan_macip_lens);
        context_desc-&gt;type_tucmd_mlhl   = cpu_to_le32(type_tucmd);
        context_desc-&gt;mss_l4len_idx     = cpu_to_le32(mss_l4len_idx);

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">We assume there is always a valid Tx time available. Invalid times</span>
<span style="font-weight: bold; font-style: italic;">         * should have been handled by the upper layers.</span>
<span style="font-weight: bold; font-style: italic;">         </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold;">if</span> (tx_ring-&gt;launchtime_enable) {
                <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_adapter</span> *<span style="font-weight: bold; font-style: italic;">adapter</span> = netdev_priv(tx_ring-&gt;netdev);
                <span style="font-weight: bold; text-decoration: underline;">ktime_t</span> <span style="font-weight: bold; font-style: italic;">txtime</span> = first-&gt;skb-&gt;tstamp;

                skb_txtime_consumed(first-&gt;skb);
                context_desc-&gt;launch_time = igc_tx_launchtime(adapter,
                                                              txtime);
        } <span style="font-weight: bold;">else</span> {
                context_desc-&gt;launch_time = 0;
        }
}
</pre>
</div>

<p>
TX descriptors macros for IGC_TX_DESC and IGC_TX_CTXTDESC seems to overlap:
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">#define</span> <span style="font-weight: bold;">IGC_TX_DESC</span>(<span style="font-weight: bold; font-style: italic;">R</span>, <span style="font-weight: bold; font-style: italic;">i</span>)       \
        (&amp;(((<span style="font-weight: bold;">union</span> <span style="font-weight: bold; text-decoration: underline;">igc_adv_tx_desc</span> *)((R)-&gt;desc))[i]))
<span style="font-weight: bold;">#define</span> <span style="font-weight: bold;">IGC_TX_CTXTDESC</span>(<span style="font-weight: bold; font-style: italic;">R</span>, <span style="font-weight: bold; font-style: italic;">i</span>)   \
        (&amp;(((<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_adv_tx_context_desc</span> *)((R)-&gt;desc))[i]))
</pre>
</div>

<p>
Layout of <code>struct igc_adv_tx_context_desc</code>:
</p>
<div class="org-src-container">
<pre class="src src-C">$ pahole -C igc_adv_tx_context_desc drivers/net/ethernet/intel/igc/igc.ko
<span style="font-weight: bold;">struct</span> igc_adv_tx_context_desc {
        <span style="font-weight: bold; text-decoration: underline;">__le32</span>                     <span style="font-weight: bold; font-style: italic;">vlan_macip_lens</span>;      <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">0     4 </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold; text-decoration: underline;">__le32</span>                     <span style="font-weight: bold; font-style: italic;">launch_time</span>;          <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">4     4 </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold; text-decoration: underline;">__le32</span>                     <span style="font-weight: bold; font-style: italic;">type_tucmd_mlhl</span>;      <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">8     4 </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold; text-decoration: underline;">__le32</span>                     <span style="font-weight: bold; font-style: italic;">mss_l4len_idx</span>;        <span style="font-weight: bold; font-style: italic;">/*    </span><span style="font-weight: bold; font-style: italic;">12     4 </span><span style="font-weight: bold; font-style: italic;">*/</span>

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">size: 16, cachelines: 1, members: 4 </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">last cacheline: 16 bytes </span><span style="font-weight: bold; font-style: italic;">*/</span>
};
</pre>
</div>

<p>
Layout of <code>union igc_adv_tx_desc</code>:
</p>
<div class="org-src-container">
<pre class="src src-C">$ pahole -C igc_adv_tx_desc drivers/net/ethernet/intel/igc/igc.ko
<span style="font-weight: bold;">union</span> igc_adv_tx_desc {
        <span style="font-weight: bold;">struct</span> {
                <span style="font-weight: bold; text-decoration: underline;">__le64</span>             <span style="font-weight: bold; font-style: italic;">buffer_addr</span>;        <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">0     8 </span><span style="font-weight: bold; font-style: italic;">*/</span>
                <span style="font-weight: bold; text-decoration: underline;">__le32</span>             <span style="font-weight: bold; font-style: italic;">cmd_type_len</span>;       <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">8     4 </span><span style="font-weight: bold; font-style: italic;">*/</span>
                <span style="font-weight: bold; text-decoration: underline;">__le32</span>             <span style="font-weight: bold; font-style: italic;">olinfo_status</span>;      <span style="font-weight: bold; font-style: italic;">/*    </span><span style="font-weight: bold; font-style: italic;">12     4 </span><span style="font-weight: bold; font-style: italic;">*/</span>
        } <span style="font-weight: bold; font-style: italic;">read</span>;                                        <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">0    16 </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold;">struct</span> {
                <span style="font-weight: bold; text-decoration: underline;">__le64</span>             <span style="font-weight: bold; font-style: italic;">rsvd</span>;               <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">0     8 </span><span style="font-weight: bold; font-style: italic;">*/</span>
                <span style="font-weight: bold; text-decoration: underline;">__le32</span>             <span style="font-weight: bold; font-style: italic;">nxtseq_seed</span>;        <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">8     4 </span><span style="font-weight: bold; font-style: italic;">*/</span>
                <span style="font-weight: bold; text-decoration: underline;">__le32</span>             <span style="font-weight: bold; font-style: italic;">status</span>;             <span style="font-weight: bold; font-style: italic;">/*    </span><span style="font-weight: bold; font-style: italic;">12     4 </span><span style="font-weight: bold; font-style: italic;">*/</span>
        } <span style="font-weight: bold; font-style: italic;">wb</span>;                                          <span style="font-weight: bold; font-style: italic;">/*     </span><span style="font-weight: bold; font-style: italic;">0    16 </span><span style="font-weight: bold; font-style: italic;">*/</span>
};
</pre>
</div>

<p>
Call paths for function: <code>igc_tx_ctxtdesc()</code>
</p>
<ul class="org-ul">
<li>igc_xmit_frame_ring (not-gso/tso) -&gt; igc_tx_csum -&gt; igc_tx_ctxtdesc</li>
<li>igc_xmit_frame_ring (gso/tso)     -&gt; igc_tso     -&gt; igc_tx_ctxtdesc</li>
</ul>

<p>
The 'launch_time' value member is 32-bit (4-bytes). Thus, it cannot contain the
64-bit (8-bytes) long 'ktime_t' value. The SW-datasheet says value LaunchTime is
only 30 bits (bits 61:32). The value resolution are reduced by this function
'igc_tx_launchtime':
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">__le32</span> <span style="font-weight: bold;">igc_tx_launchtime</span>(<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igc_adapter</span> *<span style="font-weight: bold; font-style: italic;">adapter</span>, <span style="font-weight: bold; text-decoration: underline;">ktime_t</span> <span style="font-weight: bold; font-style: italic;">txtime</span>)
{
        <span style="font-weight: bold; text-decoration: underline;">ktime_t</span> <span style="font-weight: bold; font-style: italic;">cycle_time</span> = adapter-&gt;cycle_time;
        <span style="font-weight: bold; text-decoration: underline;">ktime_t</span> <span style="font-weight: bold; font-style: italic;">base_time</span> = adapter-&gt;base_time;
        <span style="font-weight: bold; text-decoration: underline;">u32</span> <span style="font-weight: bold; font-style: italic;">launchtime</span>;

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">FIXME: when using ETF together with taprio, we may have a</span>
<span style="font-weight: bold; font-style: italic;">         * case where 'delta' is larger than the cycle_time, this may</span>
<span style="font-weight: bold; font-style: italic;">         * cause problems if we don't read the current value of</span>
<span style="font-weight: bold; font-style: italic;">         * IGC_BASET, as the value writen into the launchtime</span>
<span style="font-weight: bold; font-style: italic;">         * descriptor field may be misinterpreted.</span>
<span style="font-weight: bold; font-style: italic;">         </span><span style="font-weight: bold; font-style: italic;">*/</span>
        div_s64_rem(ktime_sub_ns(txtime, base_time), cycle_time, &amp;launchtime);

        <span style="font-weight: bold;">return</span> cpu_to_le32(launchtime);
}
</pre>
</div>

<p>
The SW-datasheet notes that there us accuracy of 6.4nsec, dictated by the
transmit scheduler operates on a 156.25 MHz clock. The packet is scheduled for
transmission when the SYSTIM registers that is defined for transmit scheduling
(by the Sch_Timer_Sel field in the TQAVCTRL register) is larger than the
"Scheduling Time".
</p>

<p>
SYSTIM register is related to: igc_ptp_read().
</p>

<p>
The LaunchTime is a relative offset, to the BaseT register and StQT[n] register
of the queue. It defines the scheduling time of the packet from the packet
buffer to the MAC. On top of it, the GTxOffset register is used to compensate
for the latency between the scheduling “point” and the PHY MDI pins.
</p>

<p>
In LaunchTime mode (via <code>igc_save_launchtime_params</code>) the cycle_time value is
10^9 <code>(#define NSEC_PER_SEC 1000000000L</code> in hex 0x3B9ACA00 fits in 32-bit). It
can be configured differently via function <a href="https://elixir.bootlin.com/linux/v5.12-rc8/A/ident/igc_save_qbv_schedule">igc_save_qbv_schedule</a> (indicating
IEEE 802.1Qbv time-aware shaper).  For LaunchTime mode is looks like the
base_time is zero.
</p>

<p>
The function <a href="https://elixir.bootlin.com/linux/v5.12-rc8/A/ident/div_s64_rem">div_s64_rem</a> :
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold;">inline</span> <span style="font-weight: bold; text-decoration: underline;">s64</span> <span style="font-weight: bold;">div_s64_rem</span>(<span style="font-weight: bold; text-decoration: underline;">s64</span> <span style="font-weight: bold; font-style: italic;">dividend</span>, <span style="font-weight: bold; text-decoration: underline;">s32</span> <span style="font-weight: bold; font-style: italic;">divisor</span>, <span style="font-weight: bold; text-decoration: underline;">s32</span> *<span style="font-weight: bold; font-style: italic;">remainder</span>)
{
        *remainder = dividend % divisor;
        <span style="font-weight: bold;">return</span> dividend / divisor;
}
</pre>
</div>

<p>
As don't use the return value, this is basically reduced to:
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold; text-decoration: underline;">u32</span> <span style="font-weight: bold; font-style: italic;">launchtime</span> = txtime % NSEC_PER_SEC;
</pre>
</div>

<p>
As txtime is in nanosec, then this basically means we can maximum schedule
packets to be send 1 second in the future.
</p>
</div>
</div>
</div>

<div id="outline-container-Driver--igb" class="outline-2">
<h2 id="Driver--igb"><a href="#Driver--igb">Driver: igb</a></h2>
<div class="outline-text-2" id="text-Driver--igb">
</div>
<div id="outline-container-Setup-code--driver--igb-" class="outline-3">
<h3 id="Setup-code--driver--igb-"><a href="#Setup-code--driver--igb-">Setup code (driver: igb)</a></h3>
<div class="outline-text-3" id="text-Setup-code--driver--igb-">
<p>
The drivers <code>ndo_setup_tc()</code> callback tell us what offload <code>type</code> it supports.
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">igb_setup_tc</span>(<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">net_device</span> *<span style="font-weight: bold; font-style: italic;">dev</span>, <span style="font-weight: bold;">enum</span> <span style="font-weight: bold; text-decoration: underline;">tc_setup_type</span> <span style="font-weight: bold; font-style: italic;">type</span>,
                        <span style="font-weight: bold; text-decoration: underline;">void</span> *<span style="font-weight: bold; font-style: italic;">type_data</span>)
{
        <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igb_adapter</span> *<span style="font-weight: bold; font-style: italic;">adapter</span> = netdev_priv(dev);

        <span style="font-weight: bold;">switch</span> (type) {
        <span style="font-weight: bold;">case</span> TC_SETUP_QDISC_CBS:
                <span style="font-weight: bold;">return</span> igb_offload_cbs(adapter, type_data);
        <span style="font-weight: bold;">case</span> TC_SETUP_BLOCK:
                <span style="font-weight: bold;">return</span> flow_block_cb_setup_simple(type_data,
                                                  &amp;igb_block_cb_list,
                                                  igb_setup_tc_block_cb,
                                                  adapter, adapter, <span style="font-weight: bold; text-decoration: underline;">true</span>);

        <span style="font-weight: bold;">case</span> TC_SETUP_QDISC_ETF:
                <span style="font-weight: bold;">return</span> igb_offload_txtime(adapter, type_data);

        <span style="font-weight: bold;">default</span>:
                <span style="font-weight: bold;">return</span> -EOPNOTSUPP;
        }

</pre>
</div>

<p>
From below code (function <a href="https://elixir.bootlin.com/linux/v5.12-rc8/source/drivers/net/ethernet/intel/igb/igb_main.c#L2780">igb_offload_txtime</a>) we identify some hardware
limitations. E.g. Launchtime offloading is only supported by queues 0 and 1.
(The function <a href="https://elixir.bootlin.com/linux/v5.12-rc8/source/drivers/net/ethernet/intel/igb/igb_main.c#L2546">igb_offload_cbs</a> also have queue 0+1 limit).
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold;">igb_offload_txtime</span>(<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igb_adapter</span> *<span style="font-weight: bold; font-style: italic;">adapter</span>,
                              <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">tc_etf_qopt_offload</span> *<span style="font-weight: bold; font-style: italic;">qopt</span>)
{
        <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">e1000_hw</span> *<span style="font-weight: bold; font-style: italic;">hw</span> = &amp;adapter-&gt;hw;
        <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">err</span>;

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">Launchtime offloading is only supported by i210 controller. </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold;">if</span> (hw-&gt;mac.type != e1000_i210)
                <span style="font-weight: bold;">return</span> -EOPNOTSUPP;

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">Launchtime offloading is only supported by queues 0 and 1. </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold;">if</span> (qopt-&gt;queue &lt; 0 || qopt-&gt;queue &gt; 1)
                <span style="font-weight: bold;">return</span> -EINVAL;

        err = igb_save_txtime_params(adapter, qopt-&gt;queue, qopt-&gt;enable);
        <span style="font-weight: bold;">if</span> (err)
                <span style="font-weight: bold;">return</span> err;

        igb_offload_apply(adapter, qopt-&gt;queue);

        <span style="font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
Function <a href="https://elixir.bootlin.com/linux/v5.12-rc8/source/drivers/net/ethernet/intel/igb/igb_main.c#L1854">igb_save_txtime_params</a> simply set <code>ring-&gt;launchtime_enable</code>.
The function <code>igb_offload_apply</code> calls function that does HW setup.
</p>

<p>
In setup function <a href="https://elixir.bootlin.com/linux/v5.12/A/ident/igb_config_tx_modes">igb_config_tx_modes()</a>, there are indications that matching
'queue==0' gets higher priority. Code talk about SR queues, which according to
datasheet means <b>Strict Reservation</b> (SR) queues. Only queue 0 and 1 can be
SR-queues.
</p>
</div>
</div>

<div id="outline-container-TX-time-to-hardware--driver--igb-" class="outline-3">
<h3 id="TX-time-to-hardware--driver--igb-"><a href="#TX-time-to-hardware--driver--igb-">TX time to hardware (driver: igb)</a></h3>
<div class="outline-text-3" id="text-TX-time-to-hardware--driver--igb-">
<p>
In function igb_tx_ctxtdesc the the "launch_time" timestamp is transferred to
the hardware via the TX context descriptor (below <code>context_desc</code> type struct
<a href="https://elixir.bootlin.com/linux/v5.12/source/drivers/net/ethernet/intel/igb/e1000_82575.h#L122">e1000_adv_tx_context_desc</a>).
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">Context descriptors </span><span style="font-weight: bold; font-style: italic;">*/</span>
<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">e1000_adv_tx_context_desc</span> {
        <span style="font-weight: bold; text-decoration: underline;">__le32</span> <span style="font-weight: bold; font-style: italic;">vlan_macip_lens</span>;
        <span style="font-weight: bold; text-decoration: underline;">__le32</span> <span style="font-weight: bold; font-style: italic;">seqnum_seed</span>;
        <span style="font-weight: bold; text-decoration: underline;">__le32</span> <span style="font-weight: bold; font-style: italic;">type_tucmd_mlhl</span>;
        <span style="font-weight: bold; text-decoration: underline;">__le32</span> <span style="font-weight: bold; font-style: italic;">mss_l4len_idx</span>;
};
</pre>
</div>

<p>
Function: igb_tx_ctxtdesc
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="font-weight: bold;">static</span> <span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">igb_tx_ctxtdesc</span>(<span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igb_ring</span> *<span style="font-weight: bold; font-style: italic;">tx_ring</span>,
                            <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">igb_tx_buffer</span> *<span style="font-weight: bold; font-style: italic;">first</span>,
                            <span style="font-weight: bold; text-decoration: underline;">u32</span> <span style="font-weight: bold; font-style: italic;">vlan_macip_lens</span>, <span style="font-weight: bold; text-decoration: underline;">u32</span> <span style="font-weight: bold; font-style: italic;">type_tucmd</span>,
                            <span style="font-weight: bold; text-decoration: underline;">u32</span> <span style="font-weight: bold; font-style: italic;">mss_l4len_idx</span>)
{
        <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">e1000_adv_tx_context_desc</span> *<span style="font-weight: bold; font-style: italic;">context_desc</span>;
        <span style="font-weight: bold; text-decoration: underline;">u16</span> <span style="font-weight: bold; font-style: italic;">i</span> = tx_ring-&gt;next_to_use;
        <span style="font-weight: bold;">struct</span> <span style="font-weight: bold; text-decoration: underline;">timespec64</span> <span style="font-weight: bold; font-style: italic;">ts</span>;

        context_desc = IGB_TX_CTXTDESC(tx_ring, i);

        i++;
        tx_ring-&gt;next_to_use = (i &lt; tx_ring-&gt;count) ? i : 0;

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">set bits to identify this as an advanced context descriptor </span><span style="font-weight: bold; font-style: italic;">*/</span>
        type_tucmd |= E1000_TXD_CMD_DEXT | E1000_ADVTXD_DTYP_CTXT;

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">For 82575, context index must be unique per ring. </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold;">if</span> (test_bit(IGB_RING_FLAG_TX_CTX_IDX, &amp;tx_ring-&gt;flags))
                mss_l4len_idx |= tx_ring-&gt;reg_idx &lt;&lt; 4;

        context_desc-&gt;vlan_macip_lens   = cpu_to_le32(vlan_macip_lens);
        context_desc-&gt;type_tucmd_mlhl   = cpu_to_le32(type_tucmd);
        context_desc-&gt;mss_l4len_idx     = cpu_to_le32(mss_l4len_idx);

        <span style="font-weight: bold; font-style: italic;">/* </span><span style="font-weight: bold; font-style: italic;">We assume there is always a valid tx time available. Invalid times</span>
<span style="font-weight: bold; font-style: italic;">         * should have been handled by the upper layers.</span>
<span style="font-weight: bold; font-style: italic;">         </span><span style="font-weight: bold; font-style: italic;">*/</span>
        <span style="font-weight: bold;">if</span> (tx_ring-&gt;launchtime_enable) {
                ts = ktime_to_timespec64(first-&gt;skb-&gt;tstamp);
                skb_txtime_consumed(first-&gt;skb);
                context_desc-&gt;seqnum_seed = cpu_to_le32(ts.tv_nsec / 32);
        } <span style="font-weight: bold;">else</span> {
                context_desc-&gt;seqnum_seed = 0;
        }
}
</pre>
</div>

<p>
We notice the member name <code>seqnum_seed</code> is less obviously (than igc) the member
to store the 'LaunchTime' value in. Again the driver comment notes that upper
layers (I assume qdisc) have made sure only valid times reach this code. Code
extracts the nsec part of the timestamp via <code>ktime_to_timespec64</code> which calls
<code>ns_to_timespec64</code>.
</p>

<p>
Datasheet for i210 section 7.2.7.5.3 ("Launch Time/Fetch Time Decision")
describe some of these limitations:
</p>

<p>
The div 32 in the code above, is because the accuracy is 32ns (or 0.032 usec):
</p>
<ul class="org-ul">
<li>Launch time/Fetch time match exactly the relevant portion of SYSTIML value.
It is compared against SYSTIML[29:5], and provides transmission granularity
of 0.032 µs.</li>
</ul>

<p>
It describes a 0.5 second limit:
</p>
<ul class="org-ul">
<li>The Allowed Fetch time and Allowed Launch time should be calculated such that
it is allowed to Fetch/Transmit a packet if the current time is within
Fetch/Launch time + 0.5 second.</li>
</ul>

<p>
The SYSTIML register wraps every second in nanosec scale:
</p>
<ul class="org-ul">
<li>Note that the SYSTIML register max value is 999,999,999 dec (0x3B9AC9FF) and
it wraps to 0 when reaching this value (representing a full second).</li>
</ul>

<p>
Datasheet i210 section 7.2.2.2.3 ("LaunchTime (25)") also describe a lot of
useful detail. The LaunchTime is a 25 bit field defined in 32 nsec units (Launch
time = LaunchTime * 32). In LaunchTime bits 56:32 in Advanced Transmit Context
Descriptor Layout (when Type = 0010b).
</p>

<p>
The 25 bit (with multiplier 32) can represent slightly above 1 sec in future:
</p>
<pre class="example" id="org40eed45">
(2^25)*32/1000000000 = 1.073741824 sec
</pre>

<p>
There is also a LaunchOffset (25 bit, 32nsec granularity):
</p>
<ul class="org-ul">
<li>The LaunchTime parameter is a relative time to the LaunchOffset parameter in
the LAUNCH_OS0 register. So, the actual Launch time equals
to 32 * (LaunchOffset + LaunchTime).</li>
<li>The calculated launch time should not exceed 1 second on which SYSTIML wraps
around.</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2021-09-20 Mon 18:33</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>

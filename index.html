<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Top-level XDP project management</title>
<meta name="generator" content="Org mode" />
<link rel="stylesheet" type="text/css" href="/styles/bigblow/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="/styles/bigblow/css/bigblow.css"/>
<link rel="stylesheet" type="text/css" href="/styles/bigblow/css/hideshow.css"/>
<script type="text/javascript" src="/styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/bigblow.js"></script>
<script type="text/javascript" src="/styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="/styles/lib/js/jquery.stickytableheaders.min.js"></script>
</head>
<body>
<div id="content">
<h1 class="title">Top-level XDP project management</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#Current-high-priority-tasks">Current high-priority tasks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_short">@short</span></span></a>
<ul>
<li><a href="#Consistency-for-statistics-with-XDP"><span class="todo TODO">TODO</span> Consistency for statistics with XDP</a>
<ul>
<li><a href="#Missing-update-of-ifconfig-counters"><span class="todo TODO">TODO</span> Missing update of ifconfig counters</a></li>
<li><a href="#Figure-out-the-counter-semantics-upstream"><span class="todo NEXT">NEXT</span> Figure out the counter semantics upstream</a></li>
<li><a href="#Statistics-per-XDP-action"><span class="todo TODO">TODO</span> Statistics per XDP-action</a>
<ul>
<li><a href="#Implement-simple-XDP-actions-counter-and-measure"><span class="todo NEXT">NEXT</span> Implement simple XDP-actions counter and measure</a></li>
<li><a href="#Exporting-XDP-actions-counter-to-userspace"><span class="todo TODO">TODO</span> Exporting XDP-actions counter to userspace</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Better-ndo_xdp_xmit-resource-management"><span class="todo TODO">TODO</span> Better ndo_xdp_xmit resource management</a>
<ul>
<li><a href="#Change-non-map-xdp_redirect-helper-to-use-a-hidden-map"><span class="todo NEXT">NEXT</span> Change non-map xdp_redirect helper to use a hidden map</a></li>
<li><a href="#Ethtool-interface-for-enabling-TX-resources"><span class="todo TODO">TODO</span> Ethtool interface for enabling TX resources</a>
<ul>
<li><a href="#Interface-for-defining-what-a-TX-resource-is">Interface for defining what a TX resource is</a></li>
</ul>
</li>
<li><a href="#Add-automatic-TX-resource-allocation-to-libbpf"><span class="todo TODO">TODO</span> Add automatic TX resource allocation to libbpf</a></li>
</ul>
</li>
<li><a href="#XDP-feature-flags"><span class="todo TODO">TODO</span> XDP feature flags</a>
<ul>
<li><a href="#Submit-LPC-network-track-talk-about--XDP-feature-detection"><span class="done DONE">DONE</span> Submit LPC network track talk about: XDP feature detection</a></li>
<li><a href="#Propose-a-driver-API-to-communicate-feature-flags"><span class="todo NEXT">NEXT</span> Propose a driver API to communicate feature flags</a>
<ul>
<li><a href="#Notes--implementation-plan">Notes: implementation plan</a></li>
</ul>
</li>
<li><a href="#Add-a-userspace-API-to-query-features"><span class="todo TODO">TODO</span> Add a userspace API to query features</a></li>
</ul>
</li>
<li><a href="#Multiple-XDP-programs-on-a-single-interface"><span class="todo TODO">TODO</span> Multiple XDP programs on a single interface</a>
<ul>
<li><a href="#Build-an-XDP-chain-loader-on-top-of-the-kernel-support"><span class="done DONE">DONE</span> Build an XDP chain loader on top of the kernel support</a></li>
<li><a href="#Implement-freplace-re-attachment"><span class="todo TODO">TODO</span> Implement freplace re-attachment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Important-medium-term-tasks">Important medium-term tasks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_medium">@medium</span></span></a>
<ul>
<li><a href="#Usability-of-programs-in-samples-bpf"><span class="todo TODO">TODO</span> Usability of programs in samples/bpf</a>
<ul>
<li><a href="#Change-sample-programs-to-accept-ifnames-as-well-as-indexes"><span class="done DONE">DONE</span> Change sample programs to accept ifnames as well as indexes</a></li>
<li><a href="#Add-TX-counters-to-redirect-samples-bpf-programs"><span class="todo NEXT">NEXT</span> Add TX counters to redirect samples/bpf programs</a></li>
<li><a href="#Fix-unloading-wrong-XDP-on-xdp-sample-exit"><span class="done DONE">DONE</span> Fix unloading wrong XDP on xdp-sample exit</a></li>
<li><a href="#Change-XDP-samples-to-enforce-native-XDP-and-report-if-not-avail"><span class="todo TODO">TODO</span> Change XDP-samples to enforce native-XDP and report if not avail</a></li>
<li><a href="#Add-xdpsock-option-to-allow-XDP_PASS-for-AF_XDP-zero-copy-mode"><span class="todo TODO">TODO</span> Add xdpsock option to allow XDP_PASS for AF_XDP zero-copy mode</a></li>
<li><a href="#xdp_monitor--record-and-show-errno"><span class="todo TODO">TODO</span> xdp_monitor: record and show errno</a></li>
<li><a href="#xdp_monitor--convert-to-use-raw-tracepoints"><span class="todo TODO">TODO</span> xdp_monitor: convert to use raw-tracepoints</a></li>
</ul>
</li>
<li><a href="#BPF-selftests---top-level-TODOs"><span class="todo TODO">TODO</span> BPF-selftests - top-level TODOs</a>
<ul>
<li><a href="#bpf-selftest--improve-XDP-VLAN-selftests"><span class="done DONE">DONE</span> bpf-selftest: improve XDP VLAN selftests</a></li>
<li><a href="#bpf-selftest--find-XDP-selftests-affected-by-veth-native-XDP"><span class="todo TODO">TODO</span> bpf-selftest: find XDP-selftests affected by veth native-XDP</a></li>
<li><a href="#Make-more-XDP-tests-using-BPF_PROG_TEST_RUN"><span class="todo TODO">TODO</span> Make more XDP tests using BPF_PROG_TEST_RUN</a></li>
<li><a href="#Could-this-be-a--introduction-job--"><span class="todo NEXT">NEXT</span> Could this be a "introduction job"?</a></li>
</ul>
</li>
<li><a href="#Busy-poll-support-for-AF_XDP"><span class="todo TODO">TODO</span> Busy-poll support for AF_XDP</a></li>
<li><a href="#Exposing-more-kernel-data-structures-through-helpers"><span class="todo TODO">TODO</span> Exposing more kernel data structures through helpers</a>
<ul>
<li><a href="#Layer-2-bridging-helper"><span class="todo NEXT">NEXT</span> Layer-2 bridging helper</a>
<ul>
<li><a href="#What-to-do-about-broadcast-multicast-"><span class="todo TODO">TODO</span> What to do about broadcast/multicast?</a></li>
</ul>
</li>
<li><a href="#Connection-flow-tracking"><span class="todo TODO">TODO</span> Connection/flow tracking</a></li>
</ul>
</li>
<li><a href="#Port-iproute2-to-libbpf"><span class="todo TODO">TODO</span> Port iproute2 to libbpf</a></li>
<li><a href="#Metadata-available-to-programs"><span class="todo TODO">TODO</span> Metadata available to programs</a>
<ul>
<li><a href="#XDP-frame-length"><span class="done DONE">DONE</span> XDP frame length</a></li>
<li><a href="#Metadata-from-hardware"><span class="todo TODO">TODO</span> Metadata from hardware</a>
<ul>
<li><a href="#Needs-BTF-based-metadata"><span class="todo TODO">TODO</span> Needs BTF-based metadata</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Improvements-to-XDP_REDIRECT"><span class="todo TODO">TODO</span> Improvements to XDP_REDIRECT</a>
<ul>
<li><a href="#Handling-multicast"><span class="todo TODO">TODO</span> Handling multicast</a></li>
<li><a href="#Queueing-and-QoS"><span class="todo TODO">TODO</span> Queueing and QoS</a></li>
<li><a href="#Handling-XDP_REDIRECT-failures"><span class="todo TODO">TODO</span> Handling XDP_REDIRECT failures</a>
<ul>
<li><a href="#Allow-lookups-in-devmap-cpumap"><span class="done DONE">DONE</span> Allow lookups in devmap/cpumap</a></li>
<li><a href="#Make-bpf_redirect_map---check-map-contents"><span class="done DONE">DONE</span> Make bpf_redirect_map() check map contents</a></li>
<li><a href="#In-samples-bpf--use-that-bpf_redirect_map---can-check-map-content"><span class="todo NEXT">NEXT</span> In samples/bpf: use that bpf_redirect_map() can check map content</a></li>
<li><a href="#Retire-bpf_redirect---helper"><span class="done CANCELLED">CANCELLED</span> Retire bpf_redirect() helper&#xa0;&#xa0;&#xa0;<span class="tag"><span class="CANCELLED">CANCELLED</span></span></a></li>
<li><a href="#What-happens-if-redirect-fails-even-though-TX-resources-are-available-"><span class="todo TODO">TODO</span> What happens if redirect fails even though TX resources are available?</a></li>
<li><a href="#Add-selftests-for-devmaps"><span class="todo TODO">TODO</span> Add selftests for devmaps</a></li>
<li><a href="#REDIRECT_MAP-idx-type---what-happens-with-namespace-moving-"><span class="todo TODO">TODO</span> REDIRECT_MAP idx type - what happens with namespace moving?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Multi-buffer-XDP--aka.-jumbo-frames-"><span class="todo TODO">TODO</span> Multi-buffer XDP (aka. jumbo-frames)</a>
<ul>
<li><a href="#Start-upstream-discussion-on-multi-buffer"><span class="done DONE">DONE</span> Start upstream discussion on multi-buffer</a></li>
<li><a href="#Create-plan-to-move-forward-with-initial-constraints"><span class="todo TODO">TODO</span> Create plan to move forward with initial constraints</a></li>
<li><a href="#Find-driver-developers-that-will-participate-in-multi-buffer-work"><span class="todo TODO">TODO</span> Find driver developers that will participate in multi-buffer work</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Longer-term-preliminary-plans">Longer-term preliminary plans&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_long">@long</span></span></a>
<ul>
<li><a href="#Adding-AF_XDP-support-to-relevant-userspace-programs"><span class="todo TODO">TODO</span> Adding AF_XDP support to relevant userspace programs</a></li>
<li><a href="#BTF-based-metadata-for-XDP"><span class="todo WAIT">WAIT</span> BTF-based metadata for XDP&#xa0;&#xa0;&#xa0;<span class="tag"><span class="WAITING">WAITING</span></span></a></li>
<li><a href="#XDP-latency-jit-vs-no-jit--tuning-etc"><span class="todo WAIT">WAIT</span> XDP latency jit-vs-no jit, tuning etc&#xa0;&#xa0;&#xa0;<span class="tag"><span class="WAITING">WAITING</span></span></a></li>
<li><a href="#Generic-XDP-fixes"><span class="todo TODO">TODO</span> Generic XDP fixes</a>
<ul>
<li><a href="#Bulking-for-redirect-maps"><span class="todo TODO">TODO</span> Bulking for redirect maps</a></li>
<li><a href="#BUG--TCP-packets-skip----"><span class="done DONE">DONE</span> BUG: TCP packets skip (?)</a></li>
<li><a href="#Fix-CPUMAP"><span class="todo TODO">TODO</span> Fix CPUMAP</a></li>
</ul>
</li>
<li><a href="#XDP-hook-at-TX"><span class="todo TODO">TODO</span> XDP hook at TX</a></li>
</ul>
</li>
<li><a href="#Site-navigation">Site navigation</a></li>
</ul>
</div>
</div>
<p>
This is the XDP project website - a rendered version of <a href="https://github.com/xdp-project/xdp-project">the Github repository</a>
for project planning.
</p>

<p>
This file contains the high-level XDP tasks. The items in this file are
divided into three categories, reflecting the urgency and time frame we
envision them being completed; although this is somewhat of a soft
categorisation, as the development is also dependent on the priorities of
the people and organisations involved. These categories are:
</p>

<ul class="org-ul">
<li>Current high-priority tasks</li>
<li>Important medium-term tasks</li>
<li>Longer-term preliminary plans</li>
</ul>

<p>
Tasks are filed under the headings corresponding to these categories below,
and each category contains a description of what it (is supposed to)
include.
</p>

<div id="outline-container-Current-high-priority-tasks" class="outline-2">
<h2 id="Current-high-priority-tasks"><a href="#Current-high-priority-tasks">Current high-priority tasks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_short">@short</span></span></a></h2>
<div class="outline-text-2" id="text-Current-high-priority-tasks">
<p>
These are tasks that are blockers for getting the XDP system ready for
general consumption, i.e., to a state that might reasonably be considered
"feature complete". This means that tasks in this category include essential
pieces of missing functionality, or significant user interface issues that
need to be resolved for wider adoption.
</p>

<p>
Tasks in this category should have a fleshed-out problem description, and
preferably a plan and someone working on them.
</p>
</div>

<div id="outline-container-Consistency-for-statistics-with-XDP" class="outline-3">
<h3 id="Consistency-for-statistics-with-XDP"><a href="#Consistency-for-statistics-with-XDP"><span class="todo TODO">TODO</span> Consistency for statistics with XDP</a></h3>
<div class="outline-text-3" id="text-Consistency-for-statistics-with-XDP">
<p>
The short of it is that we need consistency in the counters across NIC
drivers and virtual devices. Right now stats are specific to a driver with
no clear accounting for the packets and bytes handled in XDP.
</p>

<p>
Progress: @dsahern (David Ahern) have started an email thread on the
subject: <a href="https://www.spinics.net/lists/netdev/msg535239.html">consistency for statistics with XDP mode</a>
</p>
</div>

<div id="outline-container-Missing-update-of-ifconfig-counters" class="outline-4">
<h4 id="Missing-update-of-ifconfig-counters"><a href="#Missing-update-of-ifconfig-counters"><span class="todo TODO">TODO</span> Missing update of ifconfig counters</a></h4>
<div class="outline-text-4" id="text-Missing-update-of-ifconfig-counters">
<p>
Some drivers are not updating the "ifconfig" stats counters,
when in XDP mode.  This makes receive or send via XDP invisible to
sysadm/management tools.  This for-sure is going to cause confusion.
</p>

<p>
Closer look at other drivers.
</p>

<ul class="org-ul">
<li>ixgbe driver is doing the right thing.</li>

<li>i40e had a bug, where RX/TX stats are swapped (fixed in
commit <a href="https://git.kernel.org/torvalds/c/cdec2141c24e">cdec2141c24e(v4.20-rc1)</a>
("i40e: report correct statistics when XDP is enabled")).</li>

<li>mlx5 driver is not updating the regular RX/TX counters, but A LOT
of other ethtool stats counters (which are the ones I usually
monitor when testing).</li>
</ul>
</div>
</div>

<div id="outline-container-Figure-out-the-counter-semantics-upstream" class="outline-4">
<h4 id="Figure-out-the-counter-semantics-upstream"><a href="#Figure-out-the-counter-semantics-upstream"><span class="todo NEXT">NEXT</span> Figure out the counter semantics upstream</a></h4>
<div class="outline-text-4" id="text-Figure-out-the-counter-semantics-upstream">
<p>
Need to have an upstream discussion, on what is the semantic.  IHMO
the regular RX/TX counters must be updated even for XDP frames.
</p>
</div>
</div>

<div id="outline-container-Statistics-per-XDP-action" class="outline-4">
<h4 id="Statistics-per-XDP-action"><a href="#Statistics-per-XDP-action"><span class="todo TODO">TODO</span> Statistics per XDP-action</a></h4>
<div class="outline-text-4" id="text-Statistics-per-XDP-action">
<p>
Accounting per XDP-action is also inconsistent across drivers. Some driver
account nothing, while others have elaborate counters exposed as ethtool
stats.
</p>

<p>
The common pattern is that XDP programs do their own accounting of action as
they see fit, and export this as BPF maps to their associated userspace
application, which a very per application specific approach.
</p>

<p>
David Ahern (@dsahern) argues that sysadm's need something more generic and
consistent, as they need a way to diagnose the system, regardless of the XDP
program that some developer asked to get installed. This argument that a 3rd
person should be able to diagnose a running XDP program was generally
accepted upstream.
</p>

<p>
There were a lot of performance concerns around introducing XDP-action
counters. Generally upstream voices wanted this to be opt-in, e.g. something
that the sysadm explicitly enable when needed, and not default on.
</p>
</div>

<div id="outline-container-Implement-simple-XDP-actions-counter-and-measure" class="outline-5">
<h5 id="Implement-simple-XDP-actions-counter-and-measure"><a href="#Implement-simple-XDP-actions-counter-and-measure"><span class="todo NEXT">NEXT</span> Implement simple XDP-actions counter and measure</a></h5>
<div class="outline-text-5" id="text-Implement-simple-XDP-actions-counter-and-measure">
<p>
As Saeed suggested do something really simple and central like:
</p>

<div class="org-src-container">
<pre class="src src-diff"><span style="font-weight: bold;">+++ </span><span style="font-weight: bold;">b/include/linux/filter.h</span>
<span style="font-weight: bold;">@@ -651,7 +651,9 @@</span><span style="font-weight: bold;"> static __always_inline u32 bpf_prog_run_xdp(const</span>
struct bpf_prog *prog,
         * already takes rcu_read_lock() when fetching the program, so
         * it's not necessary here anymore.
         */
-       return BPF_PROG_RUN(prog, xdp);
+       u32 ret = BPF_PROG_RUN(prog, xdp);
+       xdp-&gt;xdp_rxq_info.stats[ret]++
+       return ret;
 }
</pre>
</div>

<p>
WARNING: Realised above code is subject to speculative execution
side-channel leaking.
</p>

<p>
And measure if the performance concerns are real or not. Ilias or Jesper can
measure this on a slow ARM64 platform (espressobin), as only testing this on
Intel might lead to the wrong conclusion.
</p>
</div>
</div>

<div id="outline-container-Exporting-XDP-actions-counter-to-userspace" class="outline-5">
<h5 id="Exporting-XDP-actions-counter-to-userspace"><a href="#Exporting-XDP-actions-counter-to-userspace"><span class="todo TODO">TODO</span> Exporting XDP-actions counter to userspace</a></h5>
<div class="outline-text-5" id="text-Exporting-XDP-actions-counter-to-userspace">
<p>
Collecting XDP-actions counter is only the first step.  We need to figure
out the best solution for exporting this to userspace.
</p>

<p>
One option is to piggyback on ethtool stats, which the drivers already use,
and it would also standardise the driver related XDP ethool stats.
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-Better-ndo_xdp_xmit-resource-management" class="outline-3">
<h3 id="Better-ndo_xdp_xmit-resource-management"><a href="#Better-ndo_xdp_xmit-resource-management"><span class="todo TODO">TODO</span> Better ndo_xdp_xmit resource management</a></h3>
<div class="outline-text-3" id="text-Better-ndo_xdp_xmit-resource-management">
<p>
Stalled on Intel/Magnus NIC queue management interface.
</p>

<p>
Driver resources needed to handle a ndo_xdp_xmit() is currently tied
to the driver having loaded an RX XDP program. This is strange, as
allocating these Driver TX HW resources is independent.
</p>

<p>
This can quickly lead to exhausting HW resources, like IRQs lines or
NIC TX HW queues, given it is assumed a TX queue is alloc/dedicated
for each CPU core.
</p>
</div>

<div id="outline-container-Change-non-map-xdp_redirect-helper-to-use-a-hidden-map" class="outline-4">
<h4 id="Change-non-map-xdp_redirect-helper-to-use-a-hidden-map"><a href="#Change-non-map-xdp_redirect-helper-to-use-a-hidden-map"><span class="todo NEXT">NEXT</span> Change non-map xdp_redirect helper to use a hidden map</a></h4>
<div class="outline-text-4" id="text-Change-non-map-xdp_redirect-helper-to-use-a-hidden-map">
<p>
To be able to tie resource allocation to the interface maps (<code>devmap</code>), we
first need to change the non-map redirect variant so it uses a map under the
hood. Since xdp_redirect_map() is also significantly faster than the non-map
variant, this change should be a win in itself.
</p>

<p>
v1 comments and discussion: <a href="https://patchwork.ozlabs.org/patch/1046099/">Patch 1</a> <a href="https://patchwork.ozlabs.org/patch/1046100/">Patch 2</a>
</p>

<p>
<a href="https://patchwork.ozlabs.org/cover/1050219/">v3 patchwork link</a>
</p>
</div>
</div>

<div id="outline-container-Ethtool-interface-for-enabling-TX-resources" class="outline-4">
<h4 id="Ethtool-interface-for-enabling-TX-resources"><a href="#Ethtool-interface-for-enabling-TX-resources"><span class="todo TODO">TODO</span> Ethtool interface for enabling TX resources</a></h4>
<div class="outline-text-4" id="text-Ethtool-interface-for-enabling-TX-resources">
<p>
Turns out the initial idea of using insertion into devmap as a trigger for
resource allocation doesn't work because of generic XDP. So we'll need an
ethtool interface; look into the existing channel configuration interface on
the kernel side and figure out how to express XDP resource allocation in a
good way.
</p>
</div>

<div id="outline-container-Interface-for-defining-what-a-TX-resource-is" class="outline-5">
<h5 id="Interface-for-defining-what-a-TX-resource-is"><a href="#Interface-for-defining-what-a-TX-resource-is">Interface for defining what a TX resource is</a></h5>
<div class="outline-text-5" id="text-Interface-for-defining-what-a-TX-resource-is">
<p>
Need to define:
</p>

<ul class="org-ul">
<li>Number of TX queues</li>
<li>Algorithm for picking one on a given redirect (e.g., hash on CPU)</li>
<li>Queueing behaviour</li>
</ul>

<p>
How to handle life cycle management?
</p>
</div>
</div>
</div>

<div id="outline-container-Add-automatic-TX-resource-allocation-to-libbpf" class="outline-4">
<h4 id="Add-automatic-TX-resource-allocation-to-libbpf"><a href="#Add-automatic-TX-resource-allocation-to-libbpf"><span class="todo TODO">TODO</span> Add automatic TX resource allocation to libbpf</a></h4>
<div class="outline-text-4" id="text-Add-automatic-TX-resource-allocation-to-libbpf">
<p>
Because we can't tie resource allocation to map insertion on the kernel
side, we need to solve the UI interface in userspace. So add a hook/wrapper
to libbpf that will automatically allocate TX resources when inserting into
a map.
</p>
</div>
</div>
</div>


<div id="outline-container-XDP-feature-flags" class="outline-3">
<h3 id="XDP-feature-flags"><a href="#XDP-feature-flags"><span class="todo TODO">TODO</span> XDP feature flags</a></h3>
<div class="outline-text-3" id="text-XDP-feature-flags">
<p>
We are probably going to need feature flags for XDP after all. There are use
cases (e.g. Surricata, VM migration) that will want to know what to expect
from the system before committing to loading an XDP program.
</p>
</div>

<div id="outline-container-Submit-LPC-network-track-talk-about--XDP-feature-detection" class="outline-4">
<h4 id="Submit-LPC-network-track-talk-about--XDP-feature-detection"><a href="#Submit-LPC-network-track-talk-about--XDP-feature-detection"><span class="done DONE">DONE</span> Submit LPC network track talk about: XDP feature detection</a></h4>
<div class="outline-text-4" id="text-Submit-LPC-network-track-talk-about--XDP-feature-detection">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2019-07-31 Wed 17:10]</span></span></p>
<p>
Title:
</p>
<ul class="org-ul">
<li>Improving the XDP User eXperience: via feature detection</li>
</ul>

<p>
Abstract:
</p>
<blockquote>
<p>
The most common asked question is: Does my NIC support XDP, and our current
answer is read the source code. We really need to come up with a better
answer.
</p>

<p>
The real issue is that users can attach an XDP bpf_prog to a drivers that
use features the driver doesn't implement, which cause silent drops. Or user
doesn't notice, that NIC loading fallback to generic-XDP, which is first
discovered when observing lower performance, or worse not all features are
supported with generic-XDP, resulting in unexpected packet drops.
</p>

<p>
BPF feature detection, recently added to bpftool, is based on probing the
BPF-core by loading BPF-programs using individual features (notice BPF load
time, not attaching it).
</p>

<p>
Even if your BPF loader doesn't use feature probing, it will notice if
loaded on a incompatible kernel. As an BPF-prog using something the kernel
BPF-core doesn't support will get rejected at load-time, before you attach
the BPF-prog.
</p>

<p>
This doesn't work for XDP, as features vary on a per driver basis. Currently
an XDP BPF-prog isn't aware of that driver it will get used on, until driver
attach-time. Unfortunately, due to BPF tail-calls, we cannot use the driver
attach-time hook to check for compatibility (given new XDP BPF-progs can be
indirectly "attached" via tail-call map inserts).
</p>

<p>
In this talk, we will investigate the possibilities of doing XDP feature
check at BPF load-time, by assigning an ifindex to the BPF-prog. The ground
work have already been laid by XDP hardware offload, which already need
ifindex at BPF load-time (to perform BPF byte-code translation into NIC
compatible code).
</p>

<p>
The open question are:
</p>
<ul class="org-ul">
<li>Can the verifier detect/deduce XDP feature in use, for us?</li>
<li>How does drivers express/expose XDP features?</li>
<li>Are features more than XDP return codes, like meta-data support?</li>
<li>How does this interact with generic-XDP?</li>
<li>How to expose this to userspace? (to answer does NIC support XDP)</li>
<li>How to handle tail-call map inserts?</li>
</ul>
</blockquote>
</div>
</div>

<div id="outline-container-Propose-a-driver-API-to-communicate-feature-flags" class="outline-4">
<h4 id="Propose-a-driver-API-to-communicate-feature-flags"><a href="#Propose-a-driver-API-to-communicate-feature-flags"><span class="todo NEXT">NEXT</span> Propose a driver API to communicate feature flags</a></h4>
<div class="outline-text-4" id="text-Propose-a-driver-API-to-communicate-feature-flags">
<ul class="org-ul">
<li>Daniel: Needs to go through driver BPF ndo</li>
</ul>

<p>
Needs to be an API that queries support. We cannot validate on program load
time because of tail call. Not even with cooperation from the tail-calling
program, because that may not know what features are used by the programs it
is tail-calling into.
</p>
</div>

<div id="outline-container-Notes--implementation-plan" class="outline-5">
<h5 id="Notes--implementation-plan"><a href="#Notes--implementation-plan">Notes: implementation plan</a></h5>
<div class="outline-text-5" id="text-Notes--implementation-plan">
<ul class="org-ul">
<li>On load: verifier populates bpf_prog-&gt;feature_bits</li>
<li>On load, if ifindex: reject if prog-&gt;features ^ iface-&gt;features</li>
<li>On attach: reject if prog-&gt;features ^ iface-&gt;features</li>
<li>Tail call maps:
<ul class="org-ul">
<li>On insert: if (map-&gt;feature_lock) {reject_if(prog-&gt;features ^ map-&gt;feature_lock)}
else Map-&gt;features |= prog-&gt;features</li>
<li>On prog load, if ifindex: reject if map-&gt;features ^ ifindex-&gt;features, else
progs-&gt;maps[]-&gt;feature_lock = ifindex-&gt;features
progs-&gt;features |= ifindex-&gt;features</li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-Add-a-userspace-API-to-query-features" class="outline-4">
<h4 id="Add-a-userspace-API-to-query-features"><a href="#Add-a-userspace-API-to-query-features"><span class="todo TODO">TODO</span> Add a userspace API to query features</a></h4>
<div class="outline-text-4" id="text-Add-a-userspace-API-to-query-features">
<p>
Netlink? Ethtool?
</p>
</div>
</div>
</div>

<div id="outline-container-Multiple-XDP-programs-on-a-single-interface" class="outline-3">
<h3 id="Multiple-XDP-programs-on-a-single-interface"><a href="#Multiple-XDP-programs-on-a-single-interface"><span class="todo TODO">TODO</span> Multiple XDP programs on a single interface</a></h3>
<div class="outline-text-3" id="text-Multiple-XDP-programs-on-a-single-interface">
<p>
Being able to load multiple programs on the same XDP interface is an
important use case if XDP is to see more widespread deployment (as otherwise
applications will step on each others' toes when trying to accelerate using
XDP).
</p>

<p>
The upstream solution for this is known as "dynamic re-linking", which
allows BPF global functions to be replaced by other programs. The last piece
of the kernel functionality for this was posted upstream on January 18th:
<a href="https://lore.kernel.org/bpf/20200118000657.2135859-1-ast@kernel.org/T/#t">https://lore.kernel.org/bpf/20200118000657.2135859-1-ast@kernel.org/T/#t</a>
</p>
</div>

<div id="outline-container-Build-an-XDP-chain-loader-on-top-of-the-kernel-support" class="outline-4">
<h4 id="Build-an-XDP-chain-loader-on-top-of-the-kernel-support"><a href="#Build-an-XDP-chain-loader-on-top-of-the-kernel-support"><span class="done DONE">DONE</span> Build an XDP chain loader on top of the kernel support</a></h4>
<div class="outline-text-4" id="text-Build-an-XDP-chain-loader-on-top-of-the-kernel-support">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2020-06-02 Tue 18:45]</span></span></p>
<p>
This is implemented as part of libxdp in the <a href="https://github.com/xdp-project/xdp-tools">XDP tools repo</a>. The current
implementation works for loading a dispatcher with multiple programs, but
only if they are all attached at the same time (until kernel support for
re-attaching freplace programs land).
</p>
</div>
</div>

<div id="outline-container-Implement-freplace-re-attachment" class="outline-4">
<h4 id="Implement-freplace-re-attachment"><a href="#Implement-freplace-re-attachment"><span class="todo TODO">TODO</span> Implement freplace re-attachment</a></h4>
<div class="outline-text-4" id="text-Implement-freplace-re-attachment">
<p>
To support seamlessly attaching additional XDP programs onto an interface,
we need the kernel to support re-attaching an existing freplace program in
multiple places, so the programs can be attached to a new dispatcher which
can then be atomically swapped onto the interface XDP hook.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-Important-medium-term-tasks" class="outline-2">
<h2 id="Important-medium-term-tasks"><a href="#Important-medium-term-tasks">Important medium-term tasks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_medium">@medium</span></span></a></h2>
<div class="outline-text-2" id="text-Important-medium-term-tasks">
<p>
These are tasks that are important to fix in the medium term, but that are
not immediate blockers for functionality. This includes things like
expanding driver support, and adding new features that improve things, but
which are not essential for the basic usefulness of XDP.
</p>

<p>
Tasks in this category should at a minimum have a fleshed-out problem
description.
</p>
</div>

<div id="outline-container-Usability-of-programs-in-samples-bpf" class="outline-3">
<h3 id="Usability-of-programs-in-samples-bpf"><a href="#Usability-of-programs-in-samples-bpf"><span class="todo TODO">TODO</span> Usability of programs in samples/bpf</a></h3>
<div class="outline-text-3" id="text-Usability-of-programs-in-samples-bpf">
<p>
The samples/bpf programs xdp_redirect + xdp_redirect_map are very user
unfriendly. #1 they use raw ifindex'es as input + output. #2 the pkt/s
number count RX packets, not TX'ed packets which can be dropped silently.
Red Hat QA, got very confused by #2.
</p>
</div>

<div id="outline-container-Change-sample-programs-to-accept-ifnames-as-well-as-indexes" class="outline-4">
<h4 id="Change-sample-programs-to-accept-ifnames-as-well-as-indexes"><a href="#Change-sample-programs-to-accept-ifnames-as-well-as-indexes"><span class="done DONE">DONE</span> Change sample programs to accept ifnames as well as indexes</a></h4>
<div class="outline-text-4" id="text-Change-sample-programs-to-accept-ifnames-as-well-as-indexes">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2019-06-25 Tue 13:32]</span></span></p>
<p>
Fixed by <a href="https://patchwork.ozlabs.org/patch/1121683/">https://patchwork.ozlabs.org/patch/1121683/</a>
</p>
</div>
</div>

<div id="outline-container-Add-TX-counters-to-redirect-samples-bpf-programs" class="outline-4">
<h4 id="Add-TX-counters-to-redirect-samples-bpf-programs"><a href="#Add-TX-counters-to-redirect-samples-bpf-programs"><span class="todo NEXT">NEXT</span> Add TX counters to redirect samples/bpf programs</a></h4>
<div class="outline-text-4" id="text-Add-TX-counters-to-redirect-samples-bpf-programs">
<p>
Simply include/sample the net_device TX stats.
</p>
</div>
</div>

<div id="outline-container-Fix-unloading-wrong-XDP-on-xdp-sample-exit" class="outline-4">
<h4 id="Fix-unloading-wrong-XDP-on-xdp-sample-exit"><a href="#Fix-unloading-wrong-XDP-on-xdp-sample-exit"><span class="done DONE">DONE</span> Fix unloading wrong XDP on xdp-sample exit</a></h4>
<div class="outline-text-4" id="text-Fix-unloading-wrong-XDP-on-xdp-sample-exit">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2020-01-24 Fri 10:50]</span></span></p>
<p>
The XDP sample programs unconditionally unload the current running XDP
program (via -1) on exit. If users are not careful with the order in-which
they start and stop XDP programs, then they get confused.
</p>

<p>
This was fixed upstream by by <a href="https://patchwork.ozlabs.org/project/netdev/list/?series=89625&amp;state=%2A&amp;archive=both">Maciej Fijalkowski</a>.
</p>
</div>
</div>

<div id="outline-container-Change-XDP-samples-to-enforce-native-XDP-and-report-if-not-avail" class="outline-4">
<h4 id="Change-XDP-samples-to-enforce-native-XDP-and-report-if-not-avail"><a href="#Change-XDP-samples-to-enforce-native-XDP-and-report-if-not-avail"><span class="todo TODO">TODO</span> Change XDP-samples to enforce native-XDP and report if not avail</a></h4>
<div class="outline-text-4" id="text-Change-XDP-samples-to-enforce-native-XDP-and-report-if-not-avail">
<p>
The default behaviour when attaching an XDP program on a driver that doesn't
have native-XDP is to fallback to generic-XDP, without notifying the user of
the end-state.
</p>

<p>
This behaviour is also used by xdp-samples, which unfortunately have lead
end-users to falsely think a given driver supports native-XDP. (QA are using
these xdp-samples and create cases due to this confusion).
</p>

<p>
Proposal is to change xdp-samples to enforce native-XDP, and report if this
was not possible, together with help text that display cmdline option for
enabling generic-XDP/SKB-mode.
</p>
</div>
</div>

<div id="outline-container-Add-xdpsock-option-to-allow-XDP_PASS-for-AF_XDP-zero-copy-mode" class="outline-4">
<h4 id="Add-xdpsock-option-to-allow-XDP_PASS-for-AF_XDP-zero-copy-mode"><a href="#Add-xdpsock-option-to-allow-XDP_PASS-for-AF_XDP-zero-copy-mode"><span class="todo TODO">TODO</span> Add xdpsock option to allow XDP_PASS for AF_XDP zero-copy mode</a></h4>
<div class="outline-text-4" id="text-Add-xdpsock-option-to-allow-XDP_PASS-for-AF_XDP-zero-copy-mode">
<p>
In AF_XDP zero-copy mode, sending frame to the network stack via XDP_PASS
results in an expense code path, e.g new page_alloc for copy of payload and
SKB alloc. We need this test how slow this code path is.
</p>

<p>
Also consider testing XDP-level redirect out another net_device with
AF_XDP-ZC enabled. (I think this will just drop the packets due to
mem_type).
</p>
</div>
</div>

<div id="outline-container-xdp_monitor--record-and-show-errno" class="outline-4">
<h4 id="xdp_monitor--record-and-show-errno"><a href="#xdp_monitor--record-and-show-errno"><span class="todo TODO">TODO</span> xdp_monitor: record and show errno</a></h4>
<div class="outline-text-4" id="text-xdp_monitor--record-and-show-errno">
<p>
It would be a big help diagnosing XDP issues if the xdp_monitor program also
reported the errno.
</p>
</div>
</div>

<div id="outline-container-xdp_monitor--convert-to-use-raw-tracepoints" class="outline-4">
<h4 id="xdp_monitor--convert-to-use-raw-tracepoints"><a href="#xdp_monitor--convert-to-use-raw-tracepoints"><span class="todo TODO">TODO</span> xdp_monitor: convert to use raw-tracepoints</a></h4>
<div class="outline-text-4" id="text-xdp_monitor--convert-to-use-raw-tracepoints">
<p>
The raw-tracepoints are suppose to be much faster, and XDP monitor want to
have as little impact on the system as possible. Thus, convert to use
raw-tracepoints.
</p>
</div>
</div>
</div>

<div id="outline-container-BPF-selftests---top-level-TODOs" class="outline-3">
<h3 id="BPF-selftests---top-level-TODOs"><a href="#BPF-selftests---top-level-TODOs"><span class="todo TODO">TODO</span> BPF-selftests - top-level TODOs</a></h3>
<div class="outline-text-3" id="text-BPF-selftests---top-level-TODOs">
<p>
The kernel git-tree contains a lot of selftests for BPF located in:
<code>tools/testing/selftests/bpf/</code>.
</p>

<p>
XDP (and its performance gain) is tied closely to NIC driver code, which
makes it hard to implement selftests for (including benchmark selftests).
Still we should have a goal of doing functional testing of the XDP core-code
components (via selftests).
</p>

<p>
Since driver <code>veth</code> got native-XDP support, we have an opportunity for
writing selftests that cover both generic-XDP and native-XDP.
</p>
</div>

<div id="outline-container-bpf-selftest--improve-XDP-VLAN-selftests" class="outline-4">
<h4 id="bpf-selftest--improve-XDP-VLAN-selftests"><a href="#bpf-selftest--improve-XDP-VLAN-selftests"><span class="done DONE">DONE</span> bpf-selftest: improve XDP VLAN selftests</a></h4>
<div class="outline-text-4" id="text-bpf-selftest--improve-XDP-VLAN-selftests">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2020-01-24 Fri 10:55]</span></span></p>
<p>
<b>Assignment</b> is to improve the selftest shell-script to test both
generic-XDP and native-XDP (for veth driver).
</p>

<p>
In-progress:
</p>
<ul class="org-ul">
<li><a href="https://patchwork.ozlabs.org/project/netdev/list/?series=122796&amp;state=%2a">Patchset V1</a></li>
</ul>

<p>
XDP add/remove VLAN headers have a selftest in <code>tools/testing/selftests/bpf/</code>
in files <code>test_xdp_vlan.c</code> and <code>test_xdp_vlan.sh</code>. This test was developed
in conjunction with fixing a bug in generic-XDP (see kernel commit
<a href="https://git.kernel.org/torvalds/c/297249569932">297249569932</a> ("net: fix generic XDP to handle if eth header was mangled")).
</p>

<p>
Since driver <code>veth</code> got native-XDP support, the selftest no-longer tests
generic-XDP code path.
</p>

<p>
The ip utility (from iproute2) already support specifying, that an XDP prog
must use generic XDP when loading an XDP prog (option <code>xdpgeneric</code>).
</p>
</div>
</div>

<div id="outline-container-bpf-selftest--find-XDP-selftests-affected-by-veth-native-XDP" class="outline-4">
<h4 id="bpf-selftest--find-XDP-selftests-affected-by-veth-native-XDP"><a href="#bpf-selftest--find-XDP-selftests-affected-by-veth-native-XDP"><span class="todo TODO">TODO</span> bpf-selftest: find XDP-selftests affected by veth native-XDP</a></h4>
<div class="outline-text-4" id="text-bpf-selftest--find-XDP-selftests-affected-by-veth-native-XDP">
<p>
When driver <code>veth</code> got native-XDP support, then the XDP-selftests that were
based on <code>veth</code> changed from testing generic-XDP into testing native-XDP.
</p>

<p>
<b>Assignments:</b>
</p>
<ol class="org-ol">
<li>Determine how many and which veth based XDP-selftests are affected</li>
<li>Convert these selftests to test both generic-XDP and native-XDP</li>
</ol>
</div>
</div>

<div id="outline-container-Make-more-XDP-tests-using-BPF_PROG_TEST_RUN" class="outline-4">
<h4 id="Make-more-XDP-tests-using-BPF_PROG_TEST_RUN"><a href="#Make-more-XDP-tests-using-BPF_PROG_TEST_RUN"><span class="todo TODO">TODO</span> Make more XDP tests using BPF_PROG_TEST_RUN</a></h4>
<div class="outline-text-4" id="text-Make-more-XDP-tests-using-BPF_PROG_TEST_RUN">
<p>
<a href="https://twitter.com/bjorntopel/status/1098563282884014080?s=03">Tweet</a> by Björn Töpel (@bjorntopel):
</p>

<p>
Many people aren't aware of the BPF_PROG_TEST_RUN command. It's really neat
being able to test your XDP programs "offline". The selftests use this a
lot. Docs: <a href="https://t.co/GDd7SfNYng">https://t.co/GDd7SfNYng</a> and examples in tools/testing/selftests/bpf/.
</p>
</div>
</div>

<div id="outline-container-Could-this-be-a--introduction-job--" class="outline-4">
<h4 id="Could-this-be-a--introduction-job--"><a href="#Could-this-be-a--introduction-job--"><span class="todo NEXT">NEXT</span> Could this be a "introduction job"?</a></h4>
<div class="outline-text-4" id="text-Could-this-be-a--introduction-job--">
</div>
</div>
</div>

<div id="outline-container-Busy-poll-support-for-AF_XDP" class="outline-3">
<h3 id="Busy-poll-support-for-AF_XDP"><a href="#Busy-poll-support-for-AF_XDP"><span class="todo TODO">TODO</span> Busy-poll support for AF_XDP</a></h3>
<div class="outline-text-3" id="text-Busy-poll-support-for-AF_XDP">
<p>
Adding BUSY_POLL support to AF_XDP sockets was presented at the Linux
Plumbers Conference 2018 in Vancouver, BC. With this feature, the NAPI
context of the driver is executed from the process context by the
application calling the poll() syscall, instead of being driven by the
softirq mechanism. This has a number of benefits, for example,
being able to efficiently use a single core for application, driver
and other kernel infra that the application might need. With softirq,
we would need two cores to maintain any performance. Another benefit
is that the cachelines containing the descriptors do not have to
bounce between two caches, since this is now a core local operation as
the driver and the application is on the same core. The drawback is
that we now have to use a syscall (poll) in the data path and this
will slow things down.
</p>

<p>
There is already a busy_poll mechanisms in the kernel:
/proc/sys/net/core/busy_poll. When writing a non zero value in this
file, the busy poll support will be enabled for ALL sockets in the
system. There are a number of issues with this existing code when
applied to AF_XDP sockets.
</p>

<ul class="org-ul">
<li>The batch size is hardcoded to 8, a value that is too small for the</li>
</ul>
<p>
fast processing of XDP.
</p>

<ul class="org-ul">
<li>The semantics of poll() in busy_poll mode is that if you provide more</li>
</ul>
<p>
than one file descriptor, it will drive the napi context of the first
one supplied and if it has a packet, then it will NOT drive any of the
other. In other words, it will quit once it has found an fd with a
packet. This will not work for us, since we need all fd's napis to be
called since it is very likely that a packet will be found in each of
them. One could argue that this can be solved in user-space by
manipulating the array of fds supplied to poll() before every singel
call, but this would really complicate multi socket handling in
user-space.
</p>

<ul class="org-ul">
<li>The option is global across all sockets. Enough said.</li>
</ul>

<p>
My suggestion for addressing these issues is to introduce a new
busy_poll option that is only for AF_XDP called
XDP_BUSY_POLL_BATCH_SIZE (or something like it). This is a setsockopt
that can be supplied to individual AF_XDP sockets and the batch size
can thus also be set individually by suppling a value &gt; 0. The
semantics of this mode is that both Rx and Tx have to be driven by
calling poll(). There is no guarantee that your packets will arrive or
be sent unless you call poll() (a sendto() will still work for the Tx
case, though, but it is not necessary). In this first patch set, we
can still get interrupts and processing from NAPI in this mode, but we
have some ideas on how to disable this so that NAPI is only driven
from poll(). But that is for a later patch set. Note that the sematics
would not change when we introduce this as we already today say that
you must call poll(), since there is no guarantee otherwise that you
will receive or send packets.
</p>

<p>
When suppling multiple busy_poll AF_XDP sockets to poll() all of them
will get theire napi contexts executed, so it is guaranteed that all of
them will be driven. It is also possible to mix regular sockets,
global busy_poll sockets and the new AF_XDP sockets in the same poll()
call. The semantics for each type will be maintained, as expected.
</p>

<p>
From an implementation point of view, I believe this can be
implemented with minimal changes to the net and fs code. We can get
this new behavior by using the standar fd (non-busy poll path) and
then drive the napi from the xsk specific poll callback. We do need to
change one internal interface in order to be able to have a variable
batch size. And Jesper's xdp_rxq_info struct need to be enlarged with a
napi_id field that the drivers need to populate. This can then be used
by the xsk poll code to drive the correct NAPI.
</p>
</div>
</div>

<div id="outline-container-Exposing-more-kernel-data-structures-through-helpers" class="outline-3">
<h3 id="Exposing-more-kernel-data-structures-through-helpers"><a href="#Exposing-more-kernel-data-structures-through-helpers"><span class="todo TODO">TODO</span> Exposing more kernel data structures through helpers</a></h3>
<div class="outline-text-3" id="text-Exposing-more-kernel-data-structures-through-helpers">
<p>
One of the strengths of XDP over kernel bypass solutions is the ability to
re-use existing in-kernel data structures, such as the routing table. This
happens through kernel helpers. We already have routing, but we will need
more helpers.
</p>
</div>

<div id="outline-container-Layer-2-bridging-helper" class="outline-4">
<h4 id="Layer-2-bridging-helper"><a href="#Layer-2-bridging-helper"><span class="todo NEXT">NEXT</span> Layer-2 bridging helper</a></h4>
<div class="outline-text-4" id="text-Layer-2-bridging-helper">
<p>
The obvious next step is a l2 bridging helper that mirrors the l3 routing
one. Should be fairly straight forward to implement.
</p>

<p>
<a href="https://lore.kernel.org/bpf/1596170660-5582-1-git-send-email-komachi.yoshiki@gmail.com/">RFC series posted for this</a>.
</p>
</div>

<div id="outline-container-What-to-do-about-broadcast-multicast-" class="outline-5">
<h5 id="What-to-do-about-broadcast-multicast-"><a href="#What-to-do-about-broadcast-multicast-"><span class="todo TODO">TODO</span> What to do about broadcast/multicast?</a></h5>
<div class="outline-text-5" id="text-What-to-do-about-broadcast-multicast-">
<p>
See <a href="#Handling-multicast">Handling multicast</a> below.
</p>
</div>
</div>
</div>

<div id="outline-container-Connection-flow-tracking" class="outline-4">
<h4 id="Connection-flow-tracking"><a href="#Connection-flow-tracking"><span class="todo TODO">TODO</span> Connection/flow tracking</a></h4>
<div class="outline-text-4" id="text-Connection-flow-tracking">
<p>
Exposing either full conntrack, or the more light-weight flow tracking
support would make things like stateful firewalls easier to implement.
Probably need a concrete use case for this first, though.
</p>
</div>
</div>
</div>

<div id="outline-container-Port-iproute2-to-libbpf" class="outline-3">
<h3 id="Port-iproute2-to-libbpf"><a href="#Port-iproute2-to-libbpf"><span class="todo TODO">TODO</span> Port iproute2 to libbpf</a></h3>
<div class="outline-text-3" id="text-Port-iproute2-to-libbpf">
<p>
The iproute2 XDP loader does not use libbpf, because its implementation
predates the introduction of libbpf as the "official" upstream-blessed
library. This means that there are compatibility issues between the way
iproute2 handles maps, and the way libbpf-based loaders do.
</p>

<p>
The easiest way to fix this is probably just to port iproute2 to use libbpf.
</p>
</div>
</div>

<div id="outline-container-Metadata-available-to-programs" class="outline-3">
<h3 id="Metadata-available-to-programs"><a href="#Metadata-available-to-programs"><span class="todo TODO">TODO</span> Metadata available to programs</a></h3>
<div class="outline-text-3" id="text-Metadata-available-to-programs">
<p>
The metadata available to XDP programs through the XDP context object could
be expanded with other useful entries. This section collects lists of which
items would be useful to have, and explains why for each of them.
</p>
</div>

<div id="outline-container-XDP-frame-length" class="outline-4">
<h4 id="XDP-frame-length"><a href="#XDP-frame-length"><span class="done DONE">DONE</span> XDP frame length</a></h4>
<div class="outline-text-4" id="text-XDP-frame-length">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2020-10-19 Mon 12:55]</span></span></p>
<p>
DONE: Merge commit: <a href="https://git.kernel.org/torvalds/c/5cc5924d8315">https://git.kernel.org/torvalds/c/5cc5924d8315</a>
</p>

<p>
The length of the XDP <b>frame</b> (as opposed to the data packet) is needed for
various things:
</p>

<ul class="org-ul">
<li>Tail-extend (e.g., DNS); currently packets can only be shrunk at the tail</li>
<li>Correctly reporting skb true-size when generated from XDP frame</li>
<li>For moving skb allocation out of drivers (long-term)</li>
</ul>
</div>
</div>

<div id="outline-container-Metadata-from-hardware" class="outline-4">
<h4 id="Metadata-from-hardware"><a href="#Metadata-from-hardware"><span class="todo TODO">TODO</span> Metadata from hardware</a></h4>
<div class="outline-text-4" id="text-Metadata-from-hardware">
<p>
There are various hardware metadata items that would be useful for XDP
programs to access, to reduce the amount of processing that needs to happen
in eBPF. These include:
</p>

<ul class="org-ul">
<li>Checksum</li>
<li>Hash value</li>
<li>Flow designator</li>
<li>Higher-level protocol header offsets</li>
<li>Timestamps</li>
</ul>
</div>

<div id="outline-container-Needs-BTF-based-metadata" class="outline-5">
<h5 id="Needs-BTF-based-metadata"><a href="#Needs-BTF-based-metadata"><span class="todo TODO">TODO</span> Needs BTF-based metadata</a></h5>
<div class="outline-text-5" id="text-Needs-BTF-based-metadata">
<p>
To express this in a vendor-neutral way, we probably need to depend on the
<a href="#BTF-based-metadata-for-XDP">BTF-based metadata for XDP</a>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-Improvements-to-XDP_REDIRECT" class="outline-3">
<h3 id="Improvements-to-XDP_REDIRECT"><a href="#Improvements-to-XDP_REDIRECT"><span class="todo TODO">TODO</span> Improvements to XDP_REDIRECT</a></h3>
<div class="outline-text-3" id="text-Improvements-to-XDP_REDIRECT">
</div>
<div id="outline-container-Handling-multicast" class="outline-4">
<h4 id="Handling-multicast"><a href="#Handling-multicast"><span class="todo TODO">TODO</span> Handling multicast</a></h4>
<div class="outline-text-4" id="text-Handling-multicast">
<p>
We want to be able to REDIRECT a packet to multiple interfaces in order to
implement multicast. Relevant for the <a href="#Layer-2-bridging-helper">Layer-2 bridging helper</a>.
</p>

<p>
From the discussion at netconf2019 (), we probably want to
implement it by:
</p>

<ul class="org-ul">
<li>Using a map-in-map (or map flag) to designate a group of egress interfaces
(put multiple ifaces into a map and send to all of them in one operation).</li>

<li>Just copy the packet rather than try to do clever refcnt stuff for
multi-xmit.</li>
</ul>

<p>
As a first pass, we probably want to implement a simple multi-xmit, and
leave off the possibility for the eBPF program to modify the packet between
destinations.
</p>
</div>
</div>

<div id="outline-container-Queueing-and-QoS" class="outline-4">
<h4 id="Queueing-and-QoS"><a href="#Queueing-and-QoS"><span class="todo TODO">TODO</span> Queueing and QoS</a></h4>
<div class="outline-text-4" id="text-Queueing-and-QoS">
<p>
.
</p>

<p>
There is currently no queueing in XDP_REDIRECT, apart from the bulking queue
used in the devmaps. This means that rate transitions can't be handled
properly (e.g., redirect 100Gbps-&gt;10Gbps).
</p>

<p>
To fix this, we would need to allow queueing of some sort. Options:
</p>

<ul class="org-ul">
<li>Allow user to define a queueing structure as part of the TXQ setup</li>
<li>Create the low-level hooks necessary for eBPF-programmable queueing</li>
<li>Have some kind of "intermediate queueing structure" that can be a redirect
target, does queueing, and can forward packets on afterwards</li>
</ul>
</div>
</div>

<div id="outline-container-Handling-XDP_REDIRECT-failures" class="outline-4">
<h4 id="Handling-XDP_REDIRECT-failures"><a href="#Handling-XDP_REDIRECT-failures"><span class="todo TODO">TODO</span> Handling XDP_REDIRECT failures</a></h4>
<div class="outline-text-4" id="text-Handling-XDP_REDIRECT-failures">
<p>
Presently, an XDP program cannot know if a call to bpf_redirect_map() is
going to fail. This means that programs end up doing things like using
duplicate maps for checking if a redirect map entry exists, or to packets
being silently dropped.
</p>
</div>

<div id="outline-container-Allow-lookups-in-devmap-cpumap" class="outline-5">
<h5 id="Allow-lookups-in-devmap-cpumap"><a href="#Allow-lookups-in-devmap-cpumap"><span class="done DONE">DONE</span> Allow lookups in devmap/cpumap</a></h5>
<div class="outline-text-5" id="text-Allow-lookups-in-devmap-cpumap">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2019-06-29 Sat 18:24]</span></span></p>
<p>
Return pointer to same ID as we insert, just copy it to a scratch space
first.
</p>

<p>
Merged as <a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=0cdbb4b09a0658b72c563638d476113aadd91afb">0cdbb4b09a0</a>.
</p>
</div>
</div>

<div id="outline-container-Make-bpf_redirect_map---check-map-contents" class="outline-5">
<h5 id="Make-bpf_redirect_map---check-map-contents"><a href="#Make-bpf_redirect_map---check-map-contents"><span class="done DONE">DONE</span> Make bpf_redirect_map() check map contents</a></h5>
<div class="outline-text-5" id="text-Make-bpf_redirect_map---check-map-contents">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2019-06-29 Sat 18:25]</span></span></p>
<p>
If we simply make the redirect_map() helper check that something exists in
that position in the map, we at least catch the case where a map entry is
empty (where we <b>know</b> it is going to fail). If we then later add the
capability for a map to ensure that TX resources are available on insert, we
will get this check for free.
</p>

<p>
What is the right return code for the helper on failure? We already return
XDP_ABORTED on invalid flags, so we could create a new
REDIRECT_PASS_ON_INVALID that make non-existent map entries return XDP_PASS.
This makes it easy to implement "defer to stack on error" type programs,
<b>and</b> it makes it possible to disambiguate between "flag not understood" and
"flag understood and map is empty".
</p>

<p>
Mellanox drivers turn a failure in xdp_do_redirect() into an ABORTED action,
other drivers do not.
</p>

<p>
Merged as <a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf-next.git/commit/?id=43e74c0267a35d6f5127218054b2d80c7fe801f5">43e74c0267a3</a>.
</p>
</div>
</div>

<div id="outline-container-In-samples-bpf--use-that-bpf_redirect_map---can-check-map-content" class="outline-5">
<h5 id="In-samples-bpf--use-that-bpf_redirect_map---can-check-map-content"><a href="#In-samples-bpf--use-that-bpf_redirect_map---can-check-map-content"><span class="todo NEXT">NEXT</span> In samples/bpf: use that bpf_redirect_map() can check map content</a></h5>
<div class="outline-text-5" id="text-In-samples-bpf--use-that-bpf_redirect_map---can-check-map-content">
<p>
Toke's patchset for allowing reading redirect maps were accepted upstream,
and also the fallback return codes if map index were unpopulated.  BUT the
samples/bpf programs does not take advantage of this. Task is to update
samples/bpf to demonstrate these new features.
</p>
</div>
</div>

<div id="outline-container-Retire-bpf_redirect---helper" class="outline-5">
<h5 id="Retire-bpf_redirect---helper"><a href="#Retire-bpf_redirect---helper"><span class="done CANCELLED">CANCELLED</span> Retire bpf_redirect() helper&#xa0;&#xa0;&#xa0;<span class="tag"><span class="CANCELLED">CANCELLED</span></span></a></h5>
<div class="outline-text-5" id="text-Retire-bpf_redirect---helper">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2020-01-16 Thu 15:49]</span></span></p>
<p>
Rather than extending the bpf_redirect() helper to use hidden maps, it is
probably better to document it as deprecated and point users to use the
bpf_redirect_map() helper.
</p>
</div>
</div>

<div id="outline-container-What-happens-if-redirect-fails-even-though-TX-resources-are-available-" class="outline-5">
<h5 id="What-happens-if-redirect-fails-even-though-TX-resources-are-available-"><a href="#What-happens-if-redirect-fails-even-though-TX-resources-are-available-"><span class="todo TODO">TODO</span> What happens if redirect fails even though TX resources are available?</a></h5>
<div class="outline-text-5" id="text-What-happens-if-redirect-fails-even-though-TX-resources-are-available-">
<p>
Even with the above, we can still get failures if, e.g., TX ring runs out of
space. We can't really handle this by return, so what should we do instead?
Maybe just defer this to <a href="#XDP-hook-at-TX">XDP hook at TX</a>.
</p>
</div>
</div>

<div id="outline-container-Add-selftests-for-devmaps" class="outline-5">
<h5 id="Add-selftests-for-devmaps"><a href="#Add-selftests-for-devmaps"><span class="todo TODO">TODO</span> Add selftests for devmaps</a></h5>
<div class="outline-text-5" id="text-Add-selftests-for-devmaps">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-08-09 Fri 20:51]</span></span>

</p>
</div>
</div>
<div id="outline-container-REDIRECT_MAP-idx-type---what-happens-with-namespace-moving-" class="outline-5">
<h5 id="REDIRECT_MAP-idx-type---what-happens-with-namespace-moving-"><a href="#REDIRECT_MAP-idx-type---what-happens-with-namespace-moving-"><span class="todo TODO">TODO</span> REDIRECT_MAP idx type - what happens with namespace moving?</a></h5>
<div class="outline-text-5" id="text-REDIRECT_MAP-idx-type---what-happens-with-namespace-moving-">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-05-13 Mon 14:03]</span></span>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-Multi-buffer-XDP--aka.-jumbo-frames-" class="outline-3">
<h3 id="Multi-buffer-XDP--aka.-jumbo-frames-"><a href="#Multi-buffer-XDP--aka.-jumbo-frames-"><span class="todo TODO">TODO</span> Multi-buffer XDP (aka. jumbo-frames)</a></h3>
<div class="outline-text-3" id="text-Multi-buffer-XDP--aka.-jumbo-frames-">
<p>
As described in the design document
<a href="areas/core/xdp-multi-buffer01-design.html">areas/core/xdp-multi-buffer01-design.html</a> we need to come up with a
serious attempt at supporting multi-buffer XDP handling. The term
multi-buffer covers the uses cases: jumbo-frames, TSO/LRO, packet header
split.
</p>

<p>
Add TODO steps here to move this forward.
</p>
</div>

<div id="outline-container-Start-upstream-discussion-on-multi-buffer" class="outline-4">
<h4 id="Start-upstream-discussion-on-multi-buffer"><a href="#Start-upstream-discussion-on-multi-buffer"><span class="done DONE">DONE</span> Start upstream discussion on multi-buffer</a></h4>
<div class="outline-text-4" id="text-Start-upstream-discussion-on-multi-buffer">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2019-07-03 Wed 13:15]</span></span></p>
<p>
Link to upstream discussion:
<a href="https://lore.kernel.org/netdev/20190626103829.5360ef2d@carbon/">https://lore.kernel.org/netdev/20190626103829.5360ef2d@carbon/</a>
</p>
</div>
</div>

<div id="outline-container-Create-plan-to-move-forward-with-initial-constraints" class="outline-4">
<h4 id="Create-plan-to-move-forward-with-initial-constraints"><a href="#Create-plan-to-move-forward-with-initial-constraints"><span class="todo TODO">TODO</span> Create plan to move forward with initial constraints</a></h4>
<div class="outline-text-4" id="text-Create-plan-to-move-forward-with-initial-constraints">
<p>
As <a href="https://lore.kernel.org/netdev/CA+FuTSfKnhv9rr=cDa_4m7Dd9qkEm_oabDfyvH0T0sM+fQTU=w@mail.gmail.com/">Willem points out</a>:
As long as we don't arrive at a design that cannot be extended with
those features later.
</p>
</div>
</div>

<div id="outline-container-Find-driver-developers-that-will-participate-in-multi-buffer-work" class="outline-4">
<h4 id="Find-driver-developers-that-will-participate-in-multi-buffer-work"><a href="#Find-driver-developers-that-will-participate-in-multi-buffer-work"><span class="todo TODO">TODO</span> Find driver developers that will participate in multi-buffer work</a></h4>
<div class="outline-text-4" id="text-Find-driver-developers-that-will-participate-in-multi-buffer-work">
<p>
We need some developers that have an actual use-case for this multi-buffer
feature, and also buy-in from some driver team, else this sub-project will
not see any progress.  The Amazon guys seems to have a interest.
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-Longer-term-preliminary-plans" class="outline-2">
<h2 id="Longer-term-preliminary-plans"><a href="#Longer-term-preliminary-plans">Longer-term preliminary plans&#xa0;&#xa0;&#xa0;<span class="tag"><span class="_long">@long</span></span></a></h2>
<div class="outline-text-2" id="text-Longer-term-preliminary-plans">
<p>
These are longer-term plans or ideas that either fall into the "nice to
have" category, or which are blocked on other pieces of kernel development;
as well as ideas for things we may include in the future but which is not a
high priority at the moment.
</p>

<p>
Tasks in this category do not require any particular level of description;
so some of them may simply have a sentence or two describing them.
</p>
</div>

<div id="outline-container-Adding-AF_XDP-support-to-relevant-userspace-programs" class="outline-3">
<h3 id="Adding-AF_XDP-support-to-relevant-userspace-programs"><a href="#Adding-AF_XDP-support-to-relevant-userspace-programs"><span class="todo TODO">TODO</span> Adding AF_XDP support to relevant userspace programs</a></h3>
<div class="outline-text-3" id="text-Adding-AF_XDP-support-to-relevant-userspace-programs">
<p>
There are several high-profile userspace programs that might benefit from
AF_XDP support. Adding this (or coordinating it with the program authors)
could be a way to show the benefits of XDP.
</p>
</div>
</div>

<div id="outline-container-BTF-based-metadata-for-XDP" class="outline-3">
<h3 id="BTF-based-metadata-for-XDP"><a href="#BTF-based-metadata-for-XDP"><span class="todo WAIT">WAIT</span> BTF-based metadata for XDP&#xa0;&#xa0;&#xa0;<span class="tag"><span class="WAITING">WAITING</span></span></a></h3>
<div class="outline-text-3" id="text-BTF-based-metadata-for-XDP">
<p>
Waiting for tracing people to work out the details of BTF.
</p>
</div>
</div>
<div id="outline-container-XDP-latency-jit-vs-no-jit--tuning-etc" class="outline-3">
<h3 id="XDP-latency-jit-vs-no-jit--tuning-etc"><a href="#XDP-latency-jit-vs-no-jit--tuning-etc"><span class="todo WAIT">WAIT</span> XDP latency jit-vs-no jit, tuning etc&#xa0;&#xa0;&#xa0;<span class="tag"><span class="WAITING">WAITING</span></span></a></h3>
<div class="outline-text-3" id="text-XDP-latency-jit-vs-no-jit--tuning-etc">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2019-01-18 Fri 13:55]</span></span>
How do we ensure consistently low latency packet processing is possible with
XDP?
</p>

<p>
This paper: <a href="https://www.net.in.tum.de/fileadmin/bibtex/publications/papers/ITC30-Packet-Filtering-eBPF-XDP.pdf">Performance Implications of Packet Filtering with Linux eBPF</a>
conclude that turning on the jit <b>increases</b> the number of outliers (though
not quite clear if this is actually supported by their data). This should be
investigated.
</p>

<p>
Maybe write a tuning doc as well?
</p>

<p>
WAIT status as this is low priority for now.
</p>
</div>
</div>
<div id="outline-container-Generic-XDP-fixes" class="outline-3">
<h3 id="Generic-XDP-fixes"><a href="#Generic-XDP-fixes"><span class="todo TODO">TODO</span> Generic XDP fixes</a></h3>
<div class="outline-text-3" id="text-Generic-XDP-fixes">
<p>
Various fixes that should be fixed in generic XDP eventually
</p>
</div>

<div id="outline-container-Bulking-for-redirect-maps" class="outline-4">
<h4 id="Bulking-for-redirect-maps"><a href="#Bulking-for-redirect-maps"><span class="todo TODO">TODO</span> Bulking for redirect maps</a></h4>
</div>
<div id="outline-container-BUG--TCP-packets-skip----" class="outline-4">
<h4 id="BUG--TCP-packets-skip----"><a href="#BUG--TCP-packets-skip----"><span class="done DONE">DONE</span> BUG: TCP packets skip (?)</a></h4>
<div class="outline-text-4" id="text-BUG--TCP-packets-skip----">
<p><span class="timestamp-wrapper"><span class="timestamp-kwd">CLOSED:</span> <span class="timestamp">[2020-02-24 Mon 17:58]</span></span></p>
<p>
Fixed with commit: <a href="https://git.kernel.org/torvalds/c/ad1e03b2b3d4">ad1e03b2b3d4 ("core: Don't skip generic XDP program execution for cloned SKBs")</a>
</p>
</div>
</div>
<div id="outline-container-Fix-CPUMAP" class="outline-4">
<h4 id="Fix-CPUMAP"><a href="#Fix-CPUMAP"><span class="todo TODO">TODO</span> Fix CPUMAP</a></h4>
<div class="outline-text-4" id="text-Fix-CPUMAP">
<p>
<a href="areas/cpumap.html#ID-8f4953c1-a862-46f2-b456-da187008f355">BUG: cpumap not working for generic-XDP</a>
</p>
</div>
</div>
</div>

<div id="outline-container-XDP-hook-at-TX" class="outline-3">
<h3 id="XDP-hook-at-TX"><a href="#XDP-hook-at-TX"><span class="todo TODO">TODO</span> XDP hook at TX</a></h3>
<div class="outline-text-3" id="text-XDP-hook-at-TX">
<p>
From <a href="https://www.linuxplumbersconf.org/event/2/contributions/92/attachments/91/103/lpc18-xdp-future.pdf">the LPC 2018 paper</a>:
</p>

<blockquote>
<p>
A limitation of the current design of XDP is that programs get no feedback
if a redirect to another device fails. Instead, the packet is just silently
dropped, and the only way to see why is by attaching to the right
tracepoint. This is especially problematic when forwarding packets from a
fast device to a slower one. And the way <code>XDP_REDIRECT</code> is implemented,
there is no way for the XDP program to gain insight into the state of the
device being forwarded <i>to</i>.
</p>

<p>
We believe that a possible fix for this is to add another eBPF hook at
packet egress from a device, i.e., at the latest possible time before a
packet is put into the device TX ring. At this point, it is possible for the
driver to supply information about the current state of the TX ring buffer
(such as free space), which the eBPF program can react appropriately to, for
example by signaling ingress XDP programs to send traffic another way if the
TX ring is full, or by implementing AQM-like reactions when TX ring pressure
increases.
</p>

<p>
A crazy idea is to allow this egress eBPF hook to perform a new XDP action if it
sees the TX ring is full, such as redirecting the frame out another interface.
Allowing the full XDP feature set of modifying and truncating packet length
would also make is possible to implement a signaling protocol like that
described in <a href="http://doi.acm.org/10.1145/3098822.3098825">http://doi.acm.org/10.1145/3098822.3098825</a>.
</p>
</blockquote>
</div>
</div>
</div>



<div id="outline-container-Site-navigation" class="outline-2">
<h2 id="Site-navigation"><a href="#Site-navigation">Site navigation</a></h2>
<div class="outline-text-2" id="text-Site-navigation">
<p>
The repository contains a number of files that track more specific areas of XDP
development. These are included in the following list:
</p>
<ul class="org-ul">
<li><a href="index.html">Top-level XDP project management</a></li>

<li><a href="brainstorm.html">Brainstorm notes</a></li>
<li><a href="conference.html">Conference planning document</a></li>
<li><a href="people.html">People involved in XDP development</a></li>
<li><a href="planning.html">Project management: Planning who is working on what</a></li>
<li><a href="student-projects.html">XDP-related project ideas for students</a></li>
<li>areas
<ul class="org-ul">
<li><a href="areas/xdp_flowcache.html">Brainstorming around XDP-accelerated flowcache</a></li>
<li><a href="areas/cpumap.html">Project management for CPUMAP</a></li>
<li><a href="areas/xdp-cloud-provider.html">Project management for XDP Cloud-Provider</a></li>
<li><a href="areas/ovs.html">Project management for XDP and Open vSwitch integration</a></li>
<li><a href="areas/drivers.html">Project management for XDP driver support</a></li>
<li><a href="areas/xdp-tutorial.html">Project management for XDP-tutorial</a></li>
<li><a href="areas/mem.html">Project management for areas/mem</a></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2020-06-18 Thu 16:26</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
